<html lang="ko" class="no-js">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  

  
    
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Jest는 Code Coverage를 어떻게 측정할까? (V8) | Seokho’s blog</title>
<meta name="generator" content="Jekyll v3.9.4" />
<meta property="og:title" content="Jest는 Code Coverage를 어떻게 측정할까? (V8)" />
<meta name="author" content="Seokho Song" />
<meta property="og:locale" content="ko_KR" />
<meta name="description" content="Motivation" />
<meta property="og:description" content="Motivation" />
<link rel="canonical" href="https://blog.seokho.dev/ko/development/2023/09/23/how-to-collect-coverage-jest-v8.html" />
<meta property="og:url" content="https://blog.seokho.dev/ko/development/2023/09/23/how-to-collect-coverage-jest-v8.html" />
<meta property="og:site_name" content="Seokho’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-09-23T00:00:01+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Jest는 Code Coverage를 어떻게 측정할까? (V8)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Seokho Song"},"dateModified":"2023-09-23T00:00:01+00:00","datePublished":"2023-09-23T00:00:01+00:00","description":"Motivation","headline":"Jest는 Code Coverage를 어떻게 측정할까? (V8)","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.seokho.dev/ko/development/2023/09/23/how-to-collect-coverage-jest-v8.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://blog.seokho.dev/ko/images/avator.png"},"name":"Seokho Song"},"url":"https://blog.seokho.dev/ko/development/2023/09/23/how-to-collect-coverage-jest-v8.html"}</script>
<!-- End Jekyll SEO tag -->


  

  <script>
    /* Cut the mustard */
    if ( 'querySelector' in document && 'addEventListener' in window ) {
      document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + 'js';
    }
  </script>

  <link rel="stylesheet" href="/ko/assets/css/main.css">
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,400i,700,700i|Lora:400,400i,700,700i">
  <link rel="alternate" type="application/atom+xml" title="Seokho&#39;s blog" href="/ko/atom.xml">
<!-- start custom head snippets -->
<link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
<link rel="manifest" href="/assets/site.webmanifest">
<link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<!-- Chrome, Firefox OS and Opera -->
<meta name="theme-color" content="#252a34" />
<!-- Windows Phone -->
<meta name="msapplication-navbutton-color" content="#252a34" />
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-status-bar-style" content="#252a34" />

<!-- end custom head snippets -->

</head>


  <body class="layout--post  jest는-code-coverage를-어떻게-측정할까-v8">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#primary-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    
  <div class="navigation-wrapper">
    <a href="#menu-toggle" id="menu-toggle">Menu</a>
    <nav id="primary-nav" class="site-nav animated drop">
      <ul><li><a href="/ko/about">About</a></li><li><a href="/ko/">Home</a></li><li><a href="/ko/posts/">Posts</a></li><li><a href="/ko/categories/">Categories</a></li><li><a href="/ko/tags/">Tags</a></li><li><a href="/ko/search/">Search</a></li>
			<li><a href= "/">En</a></li>
		
	  </ul>
	</nav>
  </div><!-- /.navigation-wrapper -->


    <header class="masthead">
  <div class="wrap">
    
      <a href="/ko/" class="site-logo" rel="home" title="Seokho's blog">
        <img src="/ko/images/avator.png" class="site-logo-img animated fadeInDown" alt="Seokho's blog">
      </a>
    
    
      <h1 class="site-title animated fadeIn"><a href="/ko/">Seokho's blog</a></h1>
      <p class="site-description animated fadeIn" itemprop="description">Development and Tech blog</p>
    
  </div>
</header><!-- /.masthead -->


    <main id="main" class="main-content" aria-label="Content">
  <article class="h-entry">
    

    <div class="page-wrapper">
      <header class="page-header">
        
        
          <h1 id="page-title" class="page-title p-name">Jest는 Code Coverage를 어떻게 측정할까? (V8)
</h1>
        
      </header>

      <div class="page-sidebar">
        <div class="page-author h-card p-author"><img src="/ko/images/avator.png" class="author-avatar u-photo" alt="Seokho Song"><div class="author-info"><div class="author-name">
        <span class="p-name">Seokho Song</span>
      </div><ul class="author-links"><li class="author-link">
            <a class="u-url" rel="me" href="https://github.com/DevSDK"><i class="fab fa-github-square fa-lg" title="GitHub"></i></a>
          </li><li class="author-link">
            <a class="u-url" rel="me" href="https://www.facebook.com/100006277740856"><i class="fab fa-facebook-square fa-lg" title="Facebook"></i></a>
          </li><li class="author-link">
            <a class="u-url" rel="me" href="https://twitter.com/0xdevssh"><i class="fab fa-twitter-square fa-lg" title="Twitter"></i></a>
          </li><li class="author-link">
            <a class="u-url" rel="me" href="https://www.linkedin.com/in/seokho-song/"><i class="fab fa-linkedin fa-lg" title="LinkedIn"></i></a>
          </li></ul>

<span class="read-time">6 min read</span>

    <time class="page-date dt-published" datetime="2023-09-23T00:00:01+00:00"><a class="u-url" href="">September 23, 2023</a>
</time>

  </div>
</div>

        
  <h3 class="page-taxonomies-title" style="color:#494949">Categories</h3>
  <ul class="page-taxonomies" style="color:gray"><li class="page-taxonomy"><a class="p-category" href="/ko/categories/#development" title="Pages filed under development">development</a></li>
  </ul>


        
  <h3 class="page-taxonomies-title" style="color:#484848">Tags</h3>
  <ul class="page-taxonomies" style="color:gray"><li class="page-taxonomy"><a href="/ko/tags/#chromium" title="Pages tagged Chromium" rel="tag">Chromium</a></li><li class="page-taxonomy"><a href="/ko/tags/#v8" title="Pages tagged V8" rel="tag">V8</a></li><li class="page-taxonomy"><a href="/ko/tags/#javascript" title="Pages tagged Javascript" rel="tag">Javascript</a></li><li class="page-taxonomy"><a href="/ko/tags/#jest" title="Pages tagged Jest" rel="tag">Jest</a></li>
  </ul>


		  <h3 class="page-taxonomies-title">LANGUAGES</h3>
  <ul class="page-taxonomies"> 
	  <li class="page-taxonomy">
	  
		
	  	<a href="/development/2023/09/23/how-to-collect-coverage-jest-v8.html" >English</a> </li>
		  	
	<li class="page-taxonomy">
	  

		
			 <a href="/ko/development/2023/09/23/how-to-collect-coverage-jest-v8.html" >한국어</a> </li>
	  
  </ul>

	  </div>

      <div class="page-content">
        <div class="e-content">
			<br/>
			<h2 id="motivation">Motivation</h2>

<p>회사에 커버리지를 중심으로 한 워크플로우를 만들고자 하는데 커버리지가 정확히 무엇인지 알고자 했다.</p>

<h2 id="introduction">Introduction</h2>

<p>이 글을 통해서 <code class="language-plaintext highlighter-rouge">jest --CollectCoverage --coverageProvider=v8</code>는 어떻게 커버리지를 측정하는지 jest 를 시작으로 가볍게 v8을 살펴보며 커버리지를 어떻게 측정하는지 알게 될 것이다.</p>

<p>컴파일러 이론을 미리 알고 보면 더 읽기 수월할 것이다.</p>

<h2 id="coverage">Coverage?</h2>

<blockquote>
  <p><a href="https://en.wikipedia.org/wiki/Software_engineering">소프트웨어 공학</a>에서 <strong>코드 커버리지</strong>는 특정 Test Suite가 실행될 때 프로그램의 <strong>소스 코드</strong>가 실행되는 정도를 백분율로 측정한 것이다 - 위키피디아</p>

</blockquote>

<p>우리는 jest를 통해서 코드를 테스트하고 있으며 <code class="language-plaintext highlighter-rouge">—CollectCoverage</code> 옵션을 통해 테스트 커버리지를 측정할 수 있다.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">function</span> <span class="nx">testFunc</span><span class="p">(</span><span class="nx">a</span><span class="p">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">b</span><span class="p">:</span> <span class="nx">number</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">testFunc</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">~/hooks/func</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">test</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span><span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">testFunc</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
<span class="p">})</span>
</code></pre></div></div>

<p><img src="/uploads/2023-09-23/coverage.png" alt="Untitled" /></p>

<hr />

<h2 id="coverage-in-jest">Coverage in jest</h2>

<p>이 커버리지는 어떻게 측정하고 있는 걸까? 그리고 무엇일까?</p>

<p>V8을 기준으로 설명해 보고자 한다.</p>

<p>Jest는 내부적으로 <a href="https://github.com/SimenB/collect-v8-coverage">collect-v8-coverage</a> 패키지를 쓴다</p>

<p>내부 구현체를 보면</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="nx">startInstrumenting</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>

    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">postSession</span><span class="p">(</span><span class="dl">'</span><span class="s1">Profiler.enable</span><span class="dl">'</span><span class="p">);</span>

    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">postSession</span><span class="p">(</span><span class="dl">'</span><span class="s1">Profiler.startPreciseCoverage</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="c1">// Start</span>
      <span class="na">callCount</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">detailed</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>Start로 표현된 <code class="language-plaintext highlighter-rouge">Profiler.startPreciseCoverage</code> Chrome Devtools Protocol을 사용하여 커버리지 측정을 진행한다.</p>

<p>이는 V8의 커버리지 측정 기능을 활용하기 위해 V8에 요청을 보내는 명령어로 아래의 링크에서 구체적인 내용을 확인 할 수 있다.</p>

<p>https://chromedevtools.github.io/devtools-protocol/tot/Profiler/</p>

<p>커버리지는 저 옵션을 통해 가져오게 되는 걸 알게 되었다.</p>

<p>구체적으로 저 프로토콜을 활용해 어떻게 커버리지를 측정하고 있을까?</p>

<p>아래는 해당 프로토콜을 이용해 아래 “test 함수의” 커버리지를 계산하는 예제다.</p>
<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">Session</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">inspector</span><span class="dl">"</span><span class="p">);</span>

<span class="kd">const</span> <span class="p">{</span> <span class="nx">promisify</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">util</span><span class="dl">"</span><span class="p">);</span>

<span class="nb">global</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Session</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">postP</span> <span class="o">=</span> <span class="nx">promisify</span><span class="p">(</span><span class="nb">global</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">post</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nb">global</span><span class="p">.</span><span class="nx">session</span><span class="p">));</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nb">global</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
  <span class="k">await</span> <span class="nx">postP</span><span class="p">(</span><span class="dl">"</span><span class="s2">Profiler.enable</span><span class="dl">"</span><span class="p">);</span>

  <span class="k">await</span> <span class="nx">postP</span><span class="p">(</span><span class="dl">"</span><span class="s2">Profiler.startPreciseCoverage</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">callCount</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">detailed</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="p">});</span>

  <span class="kd">function</span> <span class="nx">test</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">l</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">test</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="nx">v</span><span class="p">));</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">test</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="o">===</span> <span class="mi">30</span><span class="p">);</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">test</span><span class="p">(</span><span class="nx">l</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">20</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">r</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">postP</span><span class="p">(</span><span class="dl">"</span><span class="s2">Profiler.takePreciseCoverage</span><span class="dl">"</span><span class="p">);</span>

  <span class="k">await</span> <span class="nx">postP</span><span class="p">(</span><span class="dl">"</span><span class="s2">Profiler.stopPreciseCoverage</span><span class="dl">"</span><span class="p">);</span>
  <span class="k">await</span> <span class="nx">postP</span><span class="p">(</span><span class="dl">"</span><span class="s2">Profiler.disable</span><span class="dl">"</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">find</span><span class="p">((</span><span class="nx">f</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="dl">"</span><span class="s2">file://</span><span class="dl">"</span><span class="p">));</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
<span class="p">}</span>

<span class="nx">main</span><span class="p">();</span>
</code></pre></div></div>

<p>이 코드를  nodejs환경에서 실행하면 다음의 결과를 콘솔에 출력할 것이다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "scriptId": "481",
    "url": "file:///Users/seokho/workspace/chromium/playground/v8_test.js",
    "functions": [
        {
            "functionName": "main",
            "ranges": [
                {
                    "startOffset": 182,
                    "endOffset": 777,
                    "count": 1
                }
            ],
            "isBlockCoverage": false
        },
        {
            "functionName": "test",
            "ranges": [
                {
                    "startOffset": 372, // byte offset
                    "endOffset": 454,
                    "count": 1
                },
                {
                    "startOffset": 409,
                    "endOffset": 431,
                    "count": 0
                }
            ],
            "isBlockCoverage": true
        },
        {
            "functionName": "",
            "ranges": [
                {
                    "startOffset": 699,
                    "endOffset": 729,
                    "count": 0
                }
            ],
            "isBlockCoverage": false
        }
    ]
}
</code></pre></div></div>

<p>여기서 볼 수 있듯이 몇 번 호출되었는지 블록 커버리지인지 여부를 포함한 정보를 소스레벨에서 조회할 수 있게 된다. offset은 바이트 단위로 소스코드 내에서의 위치 정보를 알 수 있다.</p>

<hr />

<h2 id="compiler-overview">Compiler overview</h2>

<p>아래 내용은 컴파일러의 동작에 대한 대략적인 이해가 있다면 더 이해하기 수월할 것이다.</p>

<p>아래 이미지를 통해 간략히 설명하고 넘어갈 것이다.</p>

<p><img src="/uploads/2023-09-23/v8.png" alt="Untitled" /></p>

<p>컴파일러는 다양한 파이프라인을 가지고 있는데 소스코드를 받아 중간의 AST를 구성하게 된다.</p>

<p><img src="/uploads/2023-09-23/ast.png" alt="Untitled" /></p>

<p>이 AST를 이용하여 (v8 turboshaft)IR; Intermediate Representation을 만드는데 여기까지를 컴파일러의 프론트엔드라고 부른다.</p>

<p>만들어진 IR을 입력으로 받아 목적코드를 만들거나 바이트코드를 생성하는 단계를 컴파일러의 백엔드라고 불린다. 이를 통해 소스코드가 VM과 네이티브 머신에서 실행될 수 있는 형태로 변화하는 것이다.</p>

<p>정리하자면, 코드를 트리로 만들고 트리를 중간 표현식으로 만들고, 중간 표현식을 통해 목적코드를 생성하는 과정을 거쳐 컴파일러는 코드를 컴파일한다.</p>

<hr />

<h2 id="how-to-check-coverage-in-v8">How to check coverage in V8</h2>

<p>그렇다면 이를 실행시켜주는 V8은 이 실행 여부를 어떻게 계산하고 있을까?</p>

<p>V8은 두 가지 방식으로 커버리지를 측정할 수 있게 지원한다.</p>

<ol>
  <li>Best effort
    <ol>
      <li>실제 실행 성능에 큰 영향을 주지 않지만 GC등에 의해 데이터를 잃을 수도 있다.
        <ol>
          <li><a href="https://chromedevtools.github.io/devtools-protocol/tot/Profiler/#method-getBestEffortCoverage">Profiler.getBestEffortCoverage()</a></li>
        </ol>
      </li>
    </ol>
  </li>
  <li>Precise coverage insurance
    <ol>
      <li>GC로 데이터를 잃지 않고 정확한 실행 횟수 등을 얻을 수 있지만 실행 성능 등에 영향을 받을 수 있다.
        <ol>
          <li><a href="https://chromedevtools.github.io/devtools-protocol/tot/Profiler/#method-startPreciseCoverage">Profiler.startPreciseCoverage(callCount, detailed)</a></li>
        </ol>
      </li>
    </ol>
  </li>
</ol>

<p>Best-effort coverage v8의 메커니즘을 활용하는 방식이다.</p>

<p>첫 번째로 호출 카운터라고 불리는 요소를 이용한다.</p>

<p>함수는 각각 v8의 ignition 인터프리터를 통해 호출되는데 함수가 호출될 때 마다 feedack vector의 호출 카운터를 증가시키도록 하는 방법이다.</p>

<p>두 번재는 재활용 메커니즘은 “함수의 소스 범위를 알아내는 것이다.</p>

<p>커버리지를 기록하고자 할 때 호출 카운터는 어떤 파일과 연관되는지 정보가 필요하다. 이때 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/toString">Function.prototype.toString</a>을 통해 함수의 위치를 알아낸 뒤, 부분 문자열을 추출해 내부적으로 함수의 시작과 끝 지점을 알 수 있다.</p>

<p>따라서 Best Effort 커버리지 측정 방식은 실행 환경에서 사용되는 부산물(?) 들을 재활용해 특정하는 방식이기 때문에 성능상 영향이 적다.</p>

<p>하지만 대략적인 커버리지를 알 수 있으며 GC나 기타 최적화에 의해 가려지기도 한다는 단점이 있다.</p>

<p>Precise coverage는 Block 단위 커버리지라고도 불리는데, 이는 각각의 expression block에 대한 커버리지를 한다는 이야기가 된다. 예를 들어 if 절의 than 블럭과 else 블럭에 대한 각각의 측정을 한다는 것이다.</p>

<p>Best effort도 호출 카운터를 이용하기에 오해할 수 있는데, 그때 사용되는 호출 카운터는 소스 범위만을 특정할 수 있어 블럭 단위의 정밀한 측정을 이야기하는 것은 아니다.</p>

<p>Precise Coverage 측정은 v8 컴파일러가 AST를 분석하면서 Conditional Block을 Bytecode generation 할 때 IncBlockCounter 명령어를 집어넣는다. 이 명령어가 실행되냐에 따라 Call count를 도출할 수 있고, 이를 통해 블럭단위의 커버리지를 측정할 수 있는 것이다.</p>

<hr />

<h2 id="see-with-example">See with example</h2>

<p>이번 단락에서는 위에서 설명한 개념이 어떻게 실제로 동작하는지 볼 것이다.</p>

<p>다음 함수에 대해</p>

<p>커버리지를 측정한다고 가정해본다.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">test</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">a</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">0</span>
    <span class="p">}</span> 
    <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="kd">let</span> <span class="nx">l</span> <span class="o">=</span> <span class="mi">10</span>
  <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="mi">20</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">test</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span><span class="nx">v</span><span class="p">))</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">test</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="o">===</span> <span class="mi">30</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">test</span><span class="p">(</span><span class="nx">l</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">20</span><span class="p">)</span>
</code></pre></div></div>

<p>V8 컴파일러 프론트엔드는 이 코드를 파싱하면서 AST를 구성할 것이다.</p>

<p>아래 명령어를 통해 위 코드의 AST를 출력해보자.</p>

<p><code class="language-plaintext highlighter-rouge">./d8 --print-ast ~/workspace/chromium/playground/test.js</code></p>

<div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">generating</span> <span class="n">bytecode</span> <span class="k">for</span> <span class="nl">function:</span> <span class="n">test</span><span class="p">]</span>
<span class="o">---</span> <span class="n">AST</span> <span class="o">---</span>
<span class="n">FUNC</span> <span class="n">at</span> <span class="mi">13</span>
<span class="p">.</span> <span class="n">KIND</span> <span class="mi">0</span>
<span class="p">.</span> <span class="n">LITERAL</span> <span class="n">ID</span> <span class="mi">1</span>
<span class="p">.</span> <span class="n">SUSPEND</span> <span class="n">COUNT</span> <span class="mi">0</span>
<span class="p">.</span> <span class="n">NAME</span> <span class="s">"test"</span>
<span class="p">.</span> <span class="n">PARAMS</span>
<span class="p">.</span> <span class="p">.</span> <span class="n">VAR</span> <span class="p">(</span><span class="mh">0x158832470</span><span class="p">)</span> <span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="n">VAR</span><span class="p">,</span> <span class="n">assigned</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="s">"a"</span>
<span class="p">.</span> <span class="p">.</span> <span class="n">VAR</span> <span class="p">(</span><span class="mh">0x1588324f0</span><span class="p">)</span> <span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="n">VAR</span><span class="p">,</span> <span class="n">assigned</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="s">"b"</span>
<span class="p">.</span> <span class="n">DECLS</span>
<span class="p">.</span> <span class="p">.</span> <span class="n">VARIABLE</span> <span class="p">(</span><span class="mh">0x158832470</span><span class="p">)</span> <span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="n">VAR</span><span class="p">,</span> <span class="n">assigned</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="s">"a"</span>
<span class="p">.</span> <span class="p">.</span> <span class="n">VARIABLE</span> <span class="p">(</span><span class="mh">0x1588324f0</span><span class="p">)</span> <span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="n">VAR</span><span class="p">,</span> <span class="n">assigned</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="s">"b"</span>
<span class="p">.</span> <span class="n">IF</span> <span class="n">at</span> <span class="mi">24</span> <span class="c1">// BLOCK</span>
<span class="p">.</span> <span class="p">.</span> <span class="n">CONDITION</span> <span class="n">at</span> <span class="mi">29</span> <span class="c1">// BLOCK</span>
<span class="p">.</span> <span class="p">.</span> <span class="p">.</span> <span class="n">GT</span> <span class="n">at</span> <span class="mi">29</span> <span class="c1">// BLOCK</span>
<span class="p">.</span> <span class="p">.</span> <span class="p">.</span> <span class="p">.</span> <span class="n">VAR</span> <span class="n">PROXY</span> <span class="n">parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">(</span><span class="mh">0x158832470</span><span class="p">)</span> <span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="n">VAR</span><span class="p">,</span> <span class="n">assigned</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="s">"a"</span>
<span class="p">.</span> <span class="p">.</span> <span class="p">.</span> <span class="p">.</span> <span class="n">LITERAL</span> <span class="mi">20</span> <span class="c1">// BLOCK</span>
<span class="p">.</span> <span class="p">.</span> <span class="n">THEN</span> <span class="n">at</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">// BLOCK</span>
<span class="p">.</span> <span class="p">.</span> <span class="p">.</span> <span class="n">BLOCK</span> <span class="n">at</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">// BLOCK</span>
<span class="p">.</span> <span class="p">.</span> <span class="p">.</span> <span class="p">.</span> <span class="n">RETURN</span> <span class="n">at</span> <span class="mi">41</span> <span class="c1">// BLOCK</span>
<span class="p">.</span> <span class="p">.</span> <span class="p">.</span> <span class="p">.</span> <span class="p">.</span> <span class="n">LITERAL</span> <span class="mi">0</span> <span class="c1">// BLOCK</span>
<span class="p">.</span> <span class="n">RETURN</span> <span class="n">at</span> <span class="mi">57</span><span class="c1">// BLOCK </span>
<span class="p">.</span> <span class="p">.</span> <span class="n">ADD</span> <span class="n">at</span> <span class="mi">66</span>
<span class="p">.</span> <span class="p">.</span> <span class="p">.</span> <span class="n">VAR</span> <span class="n">PROXY</span> <span class="n">parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">(</span><span class="mh">0x158832470</span><span class="p">)</span> <span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="n">VAR</span><span class="p">,</span> <span class="n">assigned</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="s">"a"</span>
<span class="p">.</span> <span class="p">.</span> <span class="p">.</span> <span class="n">VAR</span> <span class="n">PROXY</span> <span class="n">parameter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">(</span><span class="mh">0x1588324f0</span><span class="p">)</span> <span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="n">VAR</span><span class="p">,</span> <span class="n">assigned</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="s">"b"</span>
</code></pre></div></div>

<p>AST의 Block으로 표현한 부분이 함수의 블럭, 조건 등에 의한 한 <strong>블럭들이</strong> 될 것이다.</p>

<p>그러면 위 AST를 통해 만들어진 결과물은(IR; Intermediate Representation)은 컴파일러의 백엔드로 전달되어 아래와 같은 바이트코드를 만들어 낼 것이다. (아마도 IR 표현에는 해당 로직이 포함되어 있을 것이다.)</p>

<p>아래는 컴파일러가 해당 AST, IR을 전달받아 생성한 목적코드인 Bytecode (VM의 어셈블리어)다.</p>

<p><code class="language-plaintext highlighter-rouge">node --print-bytecode --print-bytecode-filter="test" ~/workspace/chromium/playground/v8_test.js</code></p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">seokho</span><span class="p">@</span><span class="nd">Dave</span> <span class="o">~</span><span class="sr">/workspace/</span><span class="nx">chromium</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">out</span><span class="o">/</span><span class="nx">Default</span> <span class="o">%</span> <span class="nx">node</span> <span class="o">--</span><span class="nx">print</span><span class="o">-</span><span class="nx">bytecode</span> <span class="o">--</span><span class="nx">print</span><span class="o">-</span><span class="nx">bytecode</span><span class="o">-</span><span class="nx">filter</span><span class="o">=</span><span class="dl">"</span><span class="s2">test</span><span class="dl">"</span> <span class="o">~</span><span class="sr">/workspace/</span><span class="nx">chromium</span><span class="o">/</span><span class="nx">playground</span><span class="o">/</span><span class="nx">v8_test</span><span class="p">.</span><span class="nx">js</span>
<span class="p">[</span><span class="nx">generated</span> <span class="nx">bytecode</span> <span class="k">for</span> <span class="kd">function</span><span class="p">:</span> <span class="nx">test</span> <span class="p">(</span><span class="mh">0x00a7d39a6811</span> <span class="o">&lt;</span><span class="nx">SharedFunctionInfo</span> <span class="nx">test</span><span class="o">&gt;</span><span class="p">)]</span>
<span class="nx">Bytecode</span> <span class="nx">length</span><span class="p">:</span> <span class="mi">21</span>
<span class="nx">Parameter</span> <span class="nx">count</span> <span class="mi">3</span>
<span class="nx">Register</span> <span class="nx">count</span> <span class="mi">0</span>
<span class="nx">Frame</span> <span class="nx">size</span> <span class="mi">0</span>
<span class="nx">OSR</span> <span class="nx">urgency</span><span class="p">:</span> <span class="mi">0</span>
<span class="nx">Bytecode</span> <span class="nx">age</span><span class="p">:</span> <span class="mi">0</span>
  <span class="mi">385</span> <span class="nx">E</span><span class="o">&gt;</span> <span class="mh">0xa7d39b8b88</span> <span class="p">@</span>    <span class="mi">0</span> <span class="p">:</span> <span class="nx">b3</span> <span class="mi">00</span>             <span class="nx">IncBlockCounter</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="mi">398</span> <span class="nx">S</span><span class="o">&gt;</span> <span class="mh">0xa7d39b8b8a</span> <span class="p">@</span>    <span class="mi">2</span> <span class="p">:</span> <span class="mi">0</span><span class="nx">d</span> <span class="mi">14</span>             <span class="nx">LdaSmi</span> <span class="p">[</span><span class="mi">20</span><span class="p">]</span>
  <span class="mi">403</span> <span class="nx">E</span><span class="o">&gt;</span> <span class="mh">0xa7d39b8b8c</span> <span class="p">@</span>    <span class="mi">4</span> <span class="p">:</span> <span class="mi">6</span><span class="nx">e</span> <span class="mi">03</span> <span class="mi">00</span>          <span class="nx">TestGreaterThan</span> <span class="nx">a0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
         <span class="mh">0xa7d39b8b8f</span> <span class="p">@</span>    <span class="mi">7</span> <span class="p">:</span> <span class="mi">99</span> <span class="mi">06</span>             <span class="nx">JumpIfFalse</span> <span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="p">(</span><span class="mh">0xa7d39b8b95</span> <span class="p">@</span> <span class="mi">13</span><span class="p">)</span>
         <span class="mh">0xa7d39b8b91</span> <span class="p">@</span>    <span class="mi">9</span> <span class="p">:</span> <span class="nx">b3</span> <span class="mi">01</span>             <span class="nx">IncBlockCounter</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="mi">417</span> <span class="nx">S</span><span class="o">&gt;</span> <span class="mh">0xa7d39b8b93</span> <span class="p">@</span>   <span class="mi">11</span> <span class="p">:</span> <span class="mi">0</span><span class="nx">c</span>                <span class="nx">LdaZero</span>
  <span class="mi">425</span> <span class="nx">S</span><span class="o">&gt;</span> <span class="mh">0xa7d39b8b94</span> <span class="p">@</span>   <span class="mi">12</span> <span class="p">:</span> <span class="nx">a9</span>                <span class="nx">Return</span>
         <span class="mh">0xa7d39b8b95</span> <span class="p">@</span>   <span class="mi">13</span> <span class="p">:</span> <span class="nx">b3</span> <span class="mi">02</span>             <span class="nx">IncBlockCounter</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span>
  <span class="mi">437</span> <span class="nx">S</span><span class="o">&gt;</span> <span class="mh">0xa7d39b8b97</span> <span class="p">@</span>   <span class="mi">15</span> <span class="p">:</span> <span class="mi">0</span><span class="nx">b</span> <span class="mi">04</span>             <span class="nx">Ldar</span> <span class="nx">a1</span>
  <span class="mi">446</span> <span class="nx">E</span><span class="o">&gt;</span> <span class="mh">0xa7d39b8b99</span> <span class="p">@</span>   <span class="mi">17</span> <span class="p">:</span> <span class="mi">39</span> <span class="mi">03</span> <span class="mi">01</span>          <span class="nx">Add</span> <span class="nx">a0</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="mi">450</span> <span class="nx">S</span><span class="o">&gt;</span> <span class="mh">0xa7d39b8b9c</span> <span class="p">@</span>   <span class="mi">20</span> <span class="p">:</span> <span class="nx">a9</span>                <span class="nx">Return</span>
<span class="nx">Constant</span> <span class="nx">pool</span> <span class="p">(</span><span class="nx">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="nx">Handler</span> <span class="nx">Table</span> <span class="p">(</span><span class="nx">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="nx">Source</span> <span class="nx">Position</span> <span class="nx">Table</span> <span class="p">(</span><span class="nx">size</span> <span class="o">=</span> <span class="mi">19</span><span class="p">)</span>
<span class="mh">0x00a7d39b8ba1</span> <span class="o">&lt;</span><span class="nx">ByteArray</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span>
</code></pre></div></div>

<p>명령어 <code class="language-plaintext highlighter-rouge">IncBlockCounter</code> 가 블록에 추가된 것을 확인할 수 있다.</p>

<p><code class="language-plaintext highlighter-rouge">IncBlockCounter(slot)</code> 명령어는 해당 블록 슬롯의 call counter를 증가시킨다.</p>

<p>이 정보를  devtools protocol을 통해 결과로 가져온 것이 첫 단락에서의 커버리지 데이터인 것이다.</p>

<hr />

<h3 id="references">References</h3>

<p>https://v8.dev/blog/javascript-code-coverage</p>

<p>https://chromedevtools.github.io/devtools-protocol/tot/Profiler/#method-startPreciseCoverage</p>

<p>https://docs.google.com/document/d/1wCydi2HEZRF0skDeLb6CH0abZnTyVo5Vz5u-jhwi7es/mobilebasic</p>

        </div>

        

        
          
  <div class="page-comments">
    <div id="disqus_thread"></div>
    <script>
      var disqus_config = function () {
        this.page.url = 'https://blog.seokho.dev/ko/development/2023/09/23/how-to-collect-coverage-jest-v8.html';
        this.page.identifier = 'https://blog.seokho.dev/ko/development/2023/09/23/how-to-collect-coverage-jest-v8.html';
      };

      (function() {
        var d = document, s = d.createElement('script');
        s.src = 'https://devsdk.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>


        

        <nav class="page-pagination" role="navigation">
  
    <a class="page-previous" href="/ko/development/2022/12/20/css-trigonometric-functions.html">
      <h4 class="page-pagination-label">Previous</h4>
      <span class="page-pagination-title">
        <i class="fas fa-arrow-left"></i> CSS 삼각 함수를 배포했다

      </span>
    </a>
  

  
    <a class="page-next" href="/ko/development/2024/01/28/issue-14595-function-array-array-sort.html">
      <h4 class="page-pagination-label">Next</h4>
      <span class="page-pagination-title">
        JS array sort((a,b) =&gt; a &lt; b) 가 정렬을 보장하지 않는 이유
 <i class="fas fa-arrow-right"></i>
      </span>
    </a>
  
</nav>

      </div>
    </div>
  </article>
</main>


    <footer id="footer" class="site-footer">
  <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
<div class="social-icons"><a class="social-icon" href="https://github.com/DevSDK"><i class="fab fa-github-square fa-2x" title="GitHub"></i></a><a class="social-icon" href="https://www.facebook.com/100006277740856"><i class="fab fa-facebook-square fa-2x" title="Facebook"></i></a><a class="social-icon" href="https://twitter.com/0xdevssh"><i class="fab fa-twitter-square fa-2x" title="Twitter"></i></a><a class="social-icon" href="https://www.linkedin.com/in/seokho-song/"><i class="fab fa-linkedin fa-2x" title="LinkedIn"></i></a><a class="social-icon" href="/ko/atom.xml"><i class="fas fa-rss-square fa-2x" title="Feed"></i></a></div><div class="copyright">
    
      <p>&copy; 2024 Seokho's blog. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://github.com/mmistakes/so-simple-theme" rel="nofollow">So Simple</a>.</p>
    
  </div>
</footer>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="/ko/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.12/js/all.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LCG7W119EZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LCG7W119EZ');
</script>


<!-- MathJax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  </body>

</html>
