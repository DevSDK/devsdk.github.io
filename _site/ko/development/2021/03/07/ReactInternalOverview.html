<html lang="ko" class="no-js">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  

  
    
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>React 파헤치기, 리액트가 동작하는 방법 (overview) | Seokho’s blog</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="React 파헤치기, 리액트가 동작하는 방법 (overview)" />
<meta name="author" content="Seokho Song" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Motivation" />
<meta property="og:description" content="Motivation" />
<link rel="canonical" href="https://devsdk.github.io/ko/development/2021/03/07/ReactInternalOverview.html" />
<meta property="og:url" content="https://devsdk.github.io/ko/development/2021/03/07/ReactInternalOverview.html" />
<meta property="og:site_name" content="Seokho’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-03-07T09:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="React 파헤치기, 리액트가 동작하는 방법 (overview)" />
<script type="application/ld+json">
{"@type":"BlogPosting","url":"https://devsdk.github.io/ko/development/2021/03/07/ReactInternalOverview.html","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://devsdk.github.io/ko/images/avator.jpeg"},"name":"Seokho Song"},"headline":"React 파헤치기, 리액트가 동작하는 방법 (overview)","dateModified":"2021-03-07T09:00:00+09:00","datePublished":"2021-03-07T09:00:00+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://devsdk.github.io/ko/development/2021/03/07/ReactInternalOverview.html"},"author":{"@type":"Person","name":"Seokho Song"},"description":"Motivation","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  

  <script>
    /* Cut the mustard */
    if ( 'querySelector' in document && 'addEventListener' in window ) {
      document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + 'js';
    }
  </script>

  <link rel="stylesheet" href="/ko/assets/css/main.css">
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,400i,700,700i|Lora:400,400i,700,700i">
  <link rel="alternate" type="application/atom+xml" title="Seokho&#39;s blog" href="/ko/atom.xml">
<!-- start custom head snippets -->
<link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
<link rel="manifest" href="/assets/site.webmanifest">
<link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">


<!-- end custom head snippets -->

</head>


  <body class="layout--post  react-파헤치기-리액트가-동작하는-방법-overview">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#primary-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    
  <div class="navigation-wrapper">
    <a href="#menu-toggle" id="menu-toggle">Menu</a>
    <nav id="primary-nav" class="site-nav animated drop">
      <ul><li><a href="/ko/about">About</a></li><li><a href="/ko/">Home</a></li><li><a href="/ko/posts/">Posts</a></li><li><a href="/ko/categories/">Categories</a></li><li><a href="/ko/tags/">Tags</a></li><li><a href="/ko/search/">Search</a></li>
			<li><a href= "/">En</a></li>
		
	  </ul>
	</nav>
  </div><!-- /.navigation-wrapper -->


    <header class="masthead">
  <div class="wrap">
    
      <a href="/ko/" class="site-logo" rel="home" title="Seokho's blog">
        <img src="/ko/images/avator.jpeg" class="site-logo-img animated fadeInDown" alt="Seokho's blog">
      </a>
    
    
      <h1 class="site-title animated fadeIn"><a href="/ko/">Seokho's blog</a></h1>
      <p class="site-description animated fadeIn" itemprop="description">Development and Tech blog</p>
    
  </div>
</header><!-- /.masthead -->


    <main id="main" class="main-content" aria-label="Content">
  <article class="h-entry">
    

    <div class="page-wrapper">
      <header class="page-header">
        
        
          <h1 id="page-title" class="page-title p-name">React 파헤치기, 리액트가 동작하는 방법 (overview)
</h1>
        
      </header>

      <div class="page-sidebar">
        <div class="page-author h-card p-author"><img src="/ko/images/avator.jpeg" class="author-avatar u-photo" alt="Seokho Song"><div class="author-info"><div class="author-name">
        <em>by</em> <span class="p-name">Seokho Song</span>
      </div><ul class="author-links"><li class="author-link">
            <a class="u-url" rel="me" href="https://github.com/DevSDK"><i class="fab fa-github-square fa-lg" title="GitHub"></i></a>
          </li><li class="author-link">
            <a class="u-url" rel="me" href="https://www.facebook.com/100006277740856"><i class="fab fa-facebook-square fa-lg" title="Facebook"></i></a>
          </li><li class="author-link">
            <a class="u-url" rel="me" href="https://twitter.com/0xdevssh"><i class="fab fa-twitter-square fa-lg" title="Twitter"></i></a>
          </li><li class="author-link">
            <a class="u-url" rel="me" href="https://www.linkedin.com/in/seokho-song/"><i class="fab fa-linkedin fa-lg" title="LinkedIn"></i></a>
          </li></ul>

<span class="read-time">2 min read</span>

    <time class="page-date dt-published" datetime="2021-03-07T09:00:00+09:00"><a class="u-url" href="">March 7, 2021</a>
</time>

  </div>
</div>

        
  <h3 class="page-taxonomies-title" style="color:#494949">Categories</h3>
  <ul class="page-taxonomies" style="color:gray"><li class="page-taxonomy"><a class="p-category" href="/ko/categories/#development" title="Pages filed under development">development</a></li>
  </ul>


        
  <h3 class="page-taxonomies-title" style="color:#484848">Tags</h3>
  <ul class="page-taxonomies" style="color:gray"><li class="page-taxonomy"><a href="/ko/tags/#react" title="Pages tagged React" rel="tag">React</a></li><li class="page-taxonomy"><a href="/ko/tags/#web" title="Pages tagged Web" rel="tag">Web</a></li><li class="page-taxonomy"><a href="/ko/tags/#react-dom" title="Pages tagged React-DOM" rel="tag">React-DOM</a></li>
  </ul>


		  <h3 class="page-taxonomies-title">LANGUAGES</h3>
  <ul class="page-taxonomies"> 
	  <li class="page-taxonomy">
	  
	  <a href="/development/2021/03/07/ReactInternalOverview.html" >English</a> </li>
	<li class="page-taxonomy">
	  

		
			 <a href="/ko/development/2021/03/07/ReactInternalOverview.html" >한국어</a> </li>
	  
  </ul>

	  </div>

      <div class="page-content">
        <div class="e-content">
			<br/>
			
			<h3 id="motivation">Motivation</h3>

<p>Chromium에서 활동하면서 웹브라우져가 어떻게 동작하는지는 어느 정도 (완벽할 순 없다고 생각한다.. 너무 거대하다.)알고 있다.</p>

<p>그리고 리액트를 사용하는 방법을 알고 있다.</p>

<p>그러나 React-DOM과 내부 사항들에 대해서는 너무 추상적으로 알고있거나 모른다고 생각한다.</p>

<p>그래서 리액트와 브라우져 사이의 블랙박스가 너무 궁금하여 몇몇 가지의 문서와 react 소스코드를 뒤졌던 결과 어느정도 오버뷰가 나올 것 같아서 블로그에 정리하도록 한다.</p>

<p>하지만 아직 완전히 모든 소스코드를 본 것은 아니며, 생략되거나, 틀릴 수도 있는 내용이다.</p>

<p>언제든지 피드백을 받는다면 반영하도록 하겠다.</p>

<p><img src="https://user-images.githubusercontent.com/18409763/110232600-03128500-7f62-11eb-8f38-c3e5015e0303.png" alt="Untitled (2)" /></p>

<p>이 글을 쓰기 시작한 큰 이유다.</p>

<p>중간에 블랙박스가 너무 많아 실제로 어떻게 동작하는지 그리고 내가 더 생각해 볼 수 있는 다른 방향은 없는지 알기가 어려웠다. 덧붙이자면 말 그대로 <strong>마법상자</strong> 가 있어서 이를 화면에 그려주고 상태를 변경시키는 작업을 하는 느낌을 받았다.</p>

<p>지금부터 그 마법상자를 열어보도록 한다.</p>

<h3 id="overview">Overview</h3>

<p><img src="https://user-images.githubusercontent.com/18409763/110232607-09a0fc80-7f62-11eb-9780-6bd6e032638c.png" alt="Untitled (3)" /></p>

<p>글 내용이 뒤죽박죽이라, 아래의 내용을 바탕으로 위의 이미지를 정리하면 다음과 같다.</p>

<p>콜백에 의해 fiber 스케쥴러가 업데이트되고, 그 스케쥴러는 fiber들의 테스크를 실행하여 산출물인 업데이트 트리(WorkInProgress or Finished)를 Commit을 통해 dom에 반영한다.</p>

<h3 id="detail">Detail</h3>

<p>React는 다음과 같은 JSX 문법을 통해 “선언적” 인 구현을 권장한다. (<a href="https://reactjs.org/docs/jsx-in-depth.html">리엑트 공식 문서</a>)</p>

<p>리액트를 처음 썼을때 가장 놀랐던 부분이기도 하다.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nc">MyButton</span> <span class="na">color</span><span class="p">=</span><span class="s">"blue"</span> <span class="na">shadowSize</span><span class="p">=</span><span class="si">{</span><span class="mi">2</span><span class="si">}</span><span class="p">&gt;</span>
  Click Me
<span class="p">&lt;/</span><span class="nc">MyButton</span><span class="p">&gt;</span>
</code></pre></div></div>

<p>공식문서에서도 설명하듯이, 이는 컴파일러에 의해 (babel-loader?) 다음과 같이 코드로 변경된다.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">React</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span>
  <span class="nx">MyButton</span><span class="p">,</span>
  <span class="p">{</span><span class="na">color</span><span class="p">:</span> <span class="dl">'</span><span class="s1">blue</span><span class="dl">'</span><span class="p">,</span> <span class="na">shadowSize</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
  <span class="dl">'</span><span class="s1">Click Me</span><span class="dl">'</span>
<span class="p">)</span>
</code></pre></div></div>

<p>이 함수를 거치면서 아래의 계층을 가진 object 형식으로 반환이 된다.</p>

<p>DOM과 유사하게 children이 있고 여러 가지 정보들을 담고 있다.</p>

<p>(위 소스코드와 아래의 결과와는 다르다. 위는 공식문서에서 가져왔다.)</p>

<p><img src="https://user-images.githubusercontent.com/18409763/110232637-3d7c2200-7f62-11eb-930c-b90f62771320.png" alt="Untitled (4)" /></p>

<p>이제 우리는 위 내용을 ReactDOM.render를 통해 react-dom에 전달한다. react-dom은 위 정보를 fiber 라는 형태로 관리한다.</p>

<p>Fiber는 react의 element는 1대1로 대응되면서 여러 내부 정보를 가지고 있는 구조이며 react의 작업의 단위가 되기도 하고, 자체적인 스택프레임을 가지는 일의 주체라고 한다.</p>

<p>reconciliation 작업에 사용된다. (fiber는 <a href="https://github.com/facebook/react/tree/master/packages/react-reconciler/src">react-reconciler</a> 패키지에서 관리한다.) 내부적인 reconciliation 알고리즘은 O(n)의 휴리스틱 한 알고리즘이라고 한다. 공식문서에서는 개발자가 key를 줌으로써 알고리즘에 힌트를 줄 수 있다는 중요한 내용이 담겨있다.</p>

<p>그렇다면 fiber는 어떤 역할을 할까?</p>

<p>너무 <a href="https://github.com/facebook/react/blob/7df65725ba7826508e0f3c0f1c6f088efdbecfca/packages/react-reconciler/src/ReactFiber.new.js#L111">필드가 많아서</a> 봤던 article의 내용 중 일부를 빌리자면 이렇게 생겼다.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
    <span class="na">stateNode</span><span class="p">:</span> <span class="k">new</span> <span class="nx">App</span><span class="p">,</span>
    <span class="na">type</span><span class="p">:</span> <span class="nx">App</span><span class="p">,</span>
    <span class="na">alternate</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
		<span class="na">chiled</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
    <span class="na">key</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="na">updateQueue</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="na">memoizedState</span><span class="p">:</span> <span class="p">{},</span>
    <span class="na">pendingProps</span><span class="p">:</span> <span class="p">{},</span>
    <span class="na">memoizedProps</span><span class="p">:</span> <span class="p">{},</span>
    <span class="na">tag</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="na">effectTag</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="na">nextEffect</span><span class="p">:</span> <span class="kc">null</span>
		<span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Tree 형태로 내용을 기반으로 순회하면서 WorkInProgress 트리를 만들게 된다. 그리고 WorkInProgress는 이후 화면으로 반영될 트리를 의미한다. 여기서 자주 보던 녀석들이 있는데 React.memo에 의해 property를 기록할 때 실제로 반영되는 필드인 memoizedProps와, 공식문서에서도 설명하던 key 필드이다.</p>

<p>또한, 자체적인 스택프레임을 가지고 있다는 부분이 정말 재밌는데, <a href="https://devsdk.github.io/ko/development/2021/02/25/ChromiumEventLoop.html">이벤트루프의 동작 방식</a> 에 따르면 js execution이 길어지면 다음 태스크가 계속 기다려야 하므로 사용자경험이 안 좋아(애니메이션이 끊긴다거나, 터치가 씹힌다거나 등) 질 수 있는 것을 방지하기 위해 도입된 방식이다.</p>

<p>fiber한테는 자체적인 실행 스택(work queue로 관리되는 듯해 보인다)을 가지고 자체적인 priority 기반 scheduler를 이용하여 태스크를 쪼개서 관리하면서 Message Queue가 다른 이벤트를 처리할 수 있도록 하여 Message Queue가 다른 task를 실행할 수 있도록 해주는 것 같다. 여기서 스케쥴러는 requestIdleCallback (requestAnimationframe?) API에 의해 호출된다.</p>

<p>이제 react-dom의 마지막 산출 단계에서는 render 페이즈와 commit 페이즈로 나뉘게 된다.</p>

<p>렌더페이즈는 위에서 서술했듯이 current 트리에서 WorkInPregress를 생성하는 (변경사항들을 찾아서 렌더링할 재료를 만드는) 단계라면 commit 페이즈는 말 그대로 화면에 그리도록 제출하는 단계이다. 여기서 didComponentMount 와 같은 lifecycle 함수들이 호출된다. (렌더 페이즈에서 호출되든 lifecycle 함수들은 UNSAFE_ 태그를 달고 있다고 한다.)</p>

<p>실제로 react 소스코드에서 <a href="https://github.com/facebook/react/blob/c7b4497988e81606f1c7686434f55a49342c9efc/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L1350">commitUpdate</a>, <a href="https://github.com/facebook/react/blob/c7b4497988e81606f1c7686434f55a49342c9efc/packages/react-dom/src/client/ReactDOMHostConfig.js#L451">commitPlacement</a> 등등을 통해 dom에 반영하는 것을 찾아볼 수 있다. 내부적으론 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Node/insertBefore">insertBefore</a> 와 같은 함수를 호출하는 것으로 보인다.</p>

<p>위 내용은 글 초반에 말했듯이, 소스코드레벨에서 완전한 이해를 바탕으로 쓴 글이 아니다.</p>

<p>몇몇 가지의 글을 보고, 소스를 뒤적이다가 오버뷰를 만들면 좋을 것 같다는 생각에 작성했다.</p>

<hr />

<p>refs</p>

<p><a href="https://indepth.dev/posts/1008/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react">https://indepth.dev/posts/1008/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react</a></p>

<p><a href="https://github.com/acdlite/react-fiber-architecture">https://github.com/acdlite/react-fiber-architecture</a></p>

<p><a href="http://bit.ly/lifeofapixel">http://bit.ly/lifeofapixel</a></p>

        </div>

        

        
          
  <div class="page-comments">
    <div id="disqus_thread"></div>
    <script>
      var disqus_config = function () {
        this.page.url = 'https://devsdk.github.io/ko/development/2021/03/07/ReactInternalOverview.html';
        this.page.identifier = 'https://devsdk.github.io/ko/development/2021/03/07/ReactInternalOverview.html';
      };

      (function() {
        var d = document, s = d.createElement('script');
        s.src = 'https://devsdk.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>


        

        <nav class="page-pagination" role="navigation">
  
    <a class="page-previous" href="/ko/development/2021/03/06/ChromeInspectorPerformnace.html">
      <h4 class="page-pagination-label">Previous</h4>
      <span class="page-pagination-title">
        <i class="fas fa-arrow-left"></i> Chrome Inspector로 화면이 왜 느린지 찾아보기

      </span>
    </a>
  

  
</nav>

      </div>
    </div>
  </article>
</main>


    <footer id="footer" class="site-footer">
  <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
<div class="social-icons"><a class="social-icon" href="https://github.com/DevSDK"><i class="fab fa-github-square fa-2x" title="GitHub"></i></a><a class="social-icon" href="https://www.facebook.com/100006277740856"><i class="fab fa-facebook-square fa-2x" title="Facebook"></i></a><a class="social-icon" href="https://twitter.com/0xdevssh"><i class="fab fa-twitter-square fa-2x" title="Twitter"></i></a><a class="social-icon" href="https://www.linkedin.com/in/seokho-song/"><i class="fab fa-linkedin fa-2x" title="LinkedIn"></i></a><a class="social-icon" href="/ko/atom.xml"><i class="fas fa-rss-square fa-2x" title="Feed"></i></a></div><div class="copyright">
    
      <p>&copy; 2021 Seokho's blog. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://github.com/mmistakes/so-simple-theme" rel="nofollow">So Simple</a>.</p>
    
  </div>
</footer>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="/ko/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.12/js/all.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LCG7W119EZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LCG7W119EZ');
</script>


<!-- MathJax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  </body>

</html>
