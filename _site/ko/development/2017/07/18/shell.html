<html lang="ko" class="no-js">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  

  
    
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>운영체제 다운 모습을 드디어! 셸 개발 완료! | Seokho’s blog</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="운영체제 다운 모습을 드디어! 셸 개발 완료!" />
<meta name="author" content="Seokho Song" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="이번 글도 꾀나 장문이 될 것 같다." />
<meta property="og:description" content="이번 글도 꾀나 장문이 될 것 같다." />
<link rel="canonical" href="https://devsdk.github.io/ko/development/2017/07/18/shell.html" />
<meta property="og:url" content="https://devsdk.github.io/ko/development/2017/07/18/shell.html" />
<meta property="og:site_name" content="Seokho’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-07-18T20:00:20+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="운영체제 다운 모습을 드디어! 셸 개발 완료!" />
<script type="application/ld+json">
{"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://devsdk.github.io/ko/images/avator.jpeg"},"name":"Seokho Song"},"author":{"@type":"Person","name":"Seokho Song"},"@type":"BlogPosting","headline":"운영체제 다운 모습을 드디어! 셸 개발 완료!","dateModified":"2017-07-18T20:00:20+09:00","datePublished":"2017-07-18T20:00:20+09:00","description":"이번 글도 꾀나 장문이 될 것 같다.","mainEntityOfPage":{"@type":"WebPage","@id":"https://devsdk.github.io/ko/development/2017/07/18/shell.html"},"url":"https://devsdk.github.io/ko/development/2017/07/18/shell.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  

  <script>
    /* Cut the mustard */
    if ( 'querySelector' in document && 'addEventListener' in window ) {
      document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + 'js';
    }
  </script>

  <link rel="stylesheet" href="/ko/assets/css/main.css">
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,400i,700,700i|Lora:400,400i,700,700i">
  <link rel="alternate" type="application/atom+xml" title="Seokho&#39;s blog" href="/ko/atom.xml">
<!-- start custom head snippets -->
<link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
<link rel="manifest" href="/assets/site.webmanifest">
<link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">


<!-- end custom head snippets -->

</head>


  <body class="layout--post  운영체제-다운-모습을-드디어-셸-개발-완료">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#primary-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    
  <div class="navigation-wrapper">
    <a href="#menu-toggle" id="menu-toggle">Menu</a>
    <nav id="primary-nav" class="site-nav animated drop">
      <ul><li><a href="/ko/about">About</a></li><li><a href="/ko/">Home</a></li><li><a href="/ko/posts/">Posts</a></li><li><a href="/ko/categories/">Categories</a></li><li><a href="/ko/tags/">Tags</a></li><li><a href="/ko/search/">Search</a></li>
			<li><a href= "/">En</a></li>
		
	  </ul>
	</nav>
  </div><!-- /.navigation-wrapper -->


    <header class="masthead">
  <div class="wrap">
    
      <a href="/ko/" class="site-logo" rel="home" title="Seokho's blog">
        <img src="/ko/images/avator.jpeg" class="site-logo-img animated fadeInDown" alt="Seokho's blog">
      </a>
    
    
      <h1 class="site-title animated fadeIn"><a href="/ko/">Seokho's blog</a></h1>
      <p class="site-description animated fadeIn" itemprop="description">Development and Tech blog</p>
    
  </div>
</header><!-- /.masthead -->


    <main id="main" class="main-content" aria-label="Content">
  <article class="h-entry">
    

    <div class="page-wrapper">
      <header class="page-header">
        
        
          <h1 id="page-title" class="page-title p-name">운영체제 다운 모습을 드디어! 셸 개발 완료!
</h1>
        
      </header>

      <div class="page-sidebar">
        <div class="page-author h-card p-author"><img src="/ko/images/avator.jpeg" class="author-avatar u-photo" alt="Seokho Song"><div class="author-info"><div class="author-name">
        <em>by</em> <span class="p-name">Seokho Song</span>
      </div><ul class="author-links"><li class="author-link">
            <a class="u-url" rel="me" href="https://github.com/DevSDK"><i class="fab fa-github-square fa-lg" title="GitHub"></i></a>
          </li><li class="author-link">
            <a class="u-url" rel="me" href="https://www.facebook.com/100006277740856"><i class="fab fa-facebook-square fa-lg" title="Facebook"></i></a>
          </li><li class="author-link">
            <a class="u-url" rel="me" href="https://twitter.com/0xdevssh"><i class="fab fa-twitter-square fa-lg" title="Twitter"></i></a>
          </li><li class="author-link">
            <a class="u-url" rel="me" href="https://www.linkedin.com/in/seokho-song/"><i class="fab fa-linkedin fa-lg" title="LinkedIn"></i></a>
          </li></ul>

<span class="read-time">11 min read</span>

    <time class="page-date dt-published" datetime="2017-07-18T20:00:20+09:00"><a class="u-url" href="">July 18, 2017</a>
</time>

  </div>
</div>

        
  <h3 class="page-taxonomies-title" style="color:#494949">Categories</h3>
  <ul class="page-taxonomies" style="color:gray"><li class="page-taxonomy"><a class="p-category" href="/ko/categories/#development" title="Pages filed under development">development</a></li>
  </ul>


        
  <h3 class="page-taxonomies-title" style="color:#484848">Tags</h3>
  <ul class="page-taxonomies" style="color:gray"><li class="page-taxonomy"><a href="/ko/tags/#0sos" title="Pages tagged 0SOS" rel="tag">0SOS</a></li><li class="page-taxonomy"><a href="/ko/tags/#os" title="Pages tagged OS" rel="tag">OS</a></li><li class="page-taxonomy"><a href="/ko/tags/#operating-system" title="Pages tagged Operating System" rel="tag">Operating System</a></li><li class="page-taxonomy"><a href="/ko/tags/#system" title="Pages tagged System" rel="tag">System</a></li><li class="page-taxonomy"><a href="/ko/tags/#cli" title="Pages tagged CLI" rel="tag">CLI</a></li><li class="page-taxonomy"><a href="/ko/tags/#shell" title="Pages tagged Shell" rel="tag">Shell</a></li><li class="page-taxonomy"><a href="/ko/tags/#64bit" title="Pages tagged 64bit" rel="tag">64bit</a></li>
  </ul>


		  <h3 class="page-taxonomies-title">LANGUAGES</h3>
  <ul class="page-taxonomies"> 
	  <li class="page-taxonomy">
	  
	  <a href="/development/2017/07/18/shell.html" >English</a> </li>
	<li class="page-taxonomy">
	  

		
			 <a href="/ko/development/2017/07/18/shell.html" >한국어</a> </li>
	  
  </ul>

	  </div>

      <div class="page-content">
        <div class="e-content">
			<br/>
			
			<p>이번 글도 꾀나 장문이 될 것 같다.</p>

<p>셸, 쉘? 셸 Shell 이다.</p>

<p>드디어 내 0SOS의 CLI 의 초기버전이 완성이 되었다.</p>

<p>이제 무언가 OS같은 모습을 가지게 되었달까…</p>

<p>그와 더불어 소스 트리가 커지고 있다. 무서울정도로…</p>

<p><img src="/uploads/2017-07-18/OS/sourcetree.png" alt="sourcetree" /></p>

<p>현제 0SOS의 소스 트리이다. 다룰것도 많고 다룬것도 많다.</p>

<p>아무튼, 이번건 개발을 이곳 저곳에서 했는데,</p>

<p>얼마전에는 또 저번에 혼자 밤을 보냈던 24시간 카페에서 아는 지인들과 떠들면서 코딩하면서</p>

<p>Printf 함수와 SPrintf 함수를 구현했다.</p>

<p><img src="/uploads/2017-07-18/OS/caffe.jpg" alt="caffe" /></p>

<p>근데 사실, 떠든게 더 많아서 그런지 카페에선 밍기적밍기적 코딩했다.</p>

<p>그러고 다음날도 코딩하고 다다음날도 코딩…</p>

<p>막, 폭풍처럼 개발하고 쉬엄 쉬엄 블로그 포스팅하며 정리하는거도 참 소소한 즐거움 인것 같다.</p>

<p>이 글도 아마 한번에 다 쓴글이 아니라 중간중간 틈틈히 쓸거 같긴 하다.</p>

<p>아무튼 아무튼, 0SOS는 콘솔 셸을 가지게 되었다.</p>

<p>멋지게 스크롤 하는 모습도 멋지다.</p>

<p>이미지로만 보면 별롤 지도 몰라서</p>

<p>이번엔 영상으로 준비했다.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/nVrrjFe16NY" frameborder="0" allowfullscreen=""></iframe>

<p>저렇게 명령어 셸로 돌리기 위해 얼마나 많은 코드와 준비를 거쳤는가….</p>

<p>16비트 어셈코드로 이뤄진 부트로더부터 시작하여, 16비트 모드에서 열씸히 준비해서 32비트 커널로 넘어가고 32비트에선 또 64비트로 넘어가기 위해 준비해서 (말이 준비지 별별게 다 필요한… 쿨럭) 64비트로 올라오고, 키보드 드라이버, 인터럽트핸들링을 위해 준비하고, 인터럽트를 활용하고..</p>

<p>이번에는 Printf함수를 만들고(나중에 쓰려고 SPrintf함수도 만들고), GetCh 함수를 만들어서 입력을 받는다. 그리고 셸 코드쪽에서 처리하는 형식.</p>

<p>이번에도 책은 잘 안봤다. 동작만 똑같이 하면 되지 하며…(게다가 무거워서 저번과 똑같이 책을 안들고 갔었다 ㅋㅋ)</p>

<p>일단, 가변인자를 사용하는거야 뭐… 많은 C언어 예제들이 있으니까 크게 걱정 없었다.</p>

<p>다만, 이걸 OS개발시 써먹을 수 있는지에 대해 좀 찾아보긴 했었다.</p>

<p>문제없이 사용 가능해 보인다.</p>

<p>일단 가변인자는 해결 완료.</p>

<p>그럼 그걸 쓸 쪽인 출력 포멧과 이스케이프 시퀀스를 구현해야 한다.</p>

<p>결과적으로, %d 와 %x, %o는 숫자-&gt;문자열 화를 거친뒤 화면에 또는 메모리에 출력해야 한다.</p>

<p>itoa 같은 표준에서 제공하는 함수는 분명히 효율적인 알고리즘을 가진 상태로 있을 것 이라고 생각했고, 구글링을 좀 해본 결과 아주 멋진 코드를 발견했다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="nf">_itoa</span><span class="p">(</span><span class="kt">long</span> <span class="n">_value</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_result</span><span class="p">,</span> <span class="kt">int</span> <span class="n">_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_base</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">_base</span> <span class="o">&gt;</span> <span class="mi">36</span><span class="p">)</span> <span class="p">{</span> <span class="o">*</span><span class="n">_result</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span> <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span> <span class="p">}</span>

	<span class="kt">char</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">_result</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr1</span> <span class="o">=</span> <span class="n">_result</span><span class="p">,</span> <span class="n">tmp_char</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp_value</span><span class="p">;</span>


	<span class="c1">//음수 양수 상관없이 처리가 가능함.</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tmp_value</span> <span class="o">=</span> <span class="n">_value</span><span class="p">;</span>
		<span class="n">_value</span> <span class="o">/=</span> <span class="n">_base</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="s">"zyxwvutsrqponmlkjihgfedcba9876543210123456789abcdefghijklmnopqrstuvwxyz"</span><span class="p">[</span><span class="mi">35</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp_value</span> <span class="o">-</span> <span class="n">_value</span> <span class="o">*</span> <span class="n">_base</span><span class="p">)];</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">_value</span><span class="p">);</span>

	<span class="c1">//Sign 처리</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp_value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">'-'</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">--</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
	<span class="c1">//Reverse</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ptr1</span> <span class="o">&lt;</span> <span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp_char</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ptr</span><span class="o">--</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ptr1</span><span class="o">++</span> <span class="o">=</span> <span class="n">tmp_char</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>약간 내 코드로 변경하긴 했지만 동작 구조는 똑같다.</p>

<p>gcc에서 사용하던 itoa 라고 한다.</p>

<p>문자열 테이블을 만들고, 양수 음수에 상관없게끔 reverse테이블을 준비해둔다.</p>

<p>그리고 그걸 이용해서 숫자에서 문자로 뽑아낸다.</p>

<p>이제 2진수에서 36진수까지 지원하는 itoa함수가 있으니, 문자를 숫자로 바꾸는 함수인 atoi 함수를 구현하기로 한다.</p>

<p>이 함수는 굳이 안찾아봐도 효율적인 방법이 보여서 걍 구현했다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">BOOL</span> <span class="nf">_atoi</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_number</span><span class="p">,</span> <span class="kt">long</span><span class="o">*</span> <span class="n">_value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">_base</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_number</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_base</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">_base</span> <span class="o">&gt;</span> <span class="mi">36</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_number</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="kt">long</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">_number</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">])</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">_ctoi</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;</span> <span class="n">_base</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">*</span> <span class="n">_base</span> <span class="o">+</span> <span class="n">num</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="o">*</span><span class="n">_value</span> <span class="o">=</span> <span class="n">sign</span><span class="o">*</span><span class="n">result</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="p">}</span>
</code></pre></div></div>

<p>위 코드에서 _ctoi 함수는 문자와 대응하는 숫자를 반환한다 ex) ‘a’ 는 10</p>

<p><a href="https://github.com/DevSDK/0SOS/blob/master/02_Kernel64/Source/Utility/String.c">(전체 코드를 보려면 여기서)</a></p>

<p>받은 숫자를 가지고 r = r * base + v 형태로 자릿수마다 반복했다.</p>

<p>예를 들어, ‘202’ 라는 10진수 숫자가 들어오면</p>

<p>1) r =  0 * 10  + 2</p>

<p>r = 2</p>

<p>2) r = 2 * 10  + 0</p>

<p>r = 20</p>

<p>3) r = 20 * 10 + 2</p>

<p>r = 202</p>

<p>종료</p>

<p>해서 202를 뽑아낸다,</p>

<p>16진수, 8진수라고 해서 다르지 않다.</p>

<p>아무튼, 활용을 위해 두 함수를 Utility/String.c 에 구현했다.</p>

<p>이제 문자를 숫자로 변환하는 함수가 준비되었으니</p>

<p>대망의 Printf와 SPrintf 함수를 구현해야한다.</p>

<p>그전에, 출력시 사용하는 attribute에 대한 정보와, 커서위치정보등을 해더파일에 정의해두었다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//Console.h</span>

<span class="cp">#ifndef __CONSOLE_H__
#define __CONSOLE_H__
#include &lt;Types.h&gt;
#include &lt;stdarg.h&gt;
</span>
<span class="cp">#define FORMAT_BUFFER_SIZE 200    
</span>
<span class="cp">#define PRINT_MEMORY 0x01
#define PRINT_OUTPUT 0x02
</span>
<span class="cp">#define CONSOLE_WIDTH 80
#define CONSOLE_HEIGHT 25
</span>
<span class="cp">#define CONSOLE_VIDEO_MEMORY    0xB8000
</span>
<span class="cp">#define CONSOLE_BACKGROUND_BLACK    0x00
#define CONSOLE_BACKGROUND_BLUE     0x10
#define CONSOLE_BACKGROUND_GREEN    0x20
#define CONSOLE_BACKGROUND_CYAN     0x30
#define CONSOLE_BACKGROUND_RED      0x40
#define CONSOLE_BACKGROUND_MAGENTA  0x50
#define CONSOLE_BACKGROUND_BROWN    0x60
#define CONSOLE_BACKGROUND_WHITE    0x70
#define CONSOLE_BACKGROUND_BLINK    0x80
</span>
<span class="cp">#define CONSOLE_FOREGROUND_DARKBLACK    0x00
#define CONSOLE_FOREGROUND_DARKBLUE     0x01
#define CONSOLE_FOREGROUND_DARKGREEN    0x02
#define CONSOLE_FOREGROUND_DARKCYAN     0x03
#define CONSOLE_FOREGROUND_DARKRED      0x04
#define CONSOLE_FOREGROUND_DARKMAGENTA  0x05
#define CONSOLE_FOREGROUND_DARKBROWN    0x06
#define CONSOLE_FOREGROUND_DARKWHITE    0x07
#define CONSOLE_FOREGROUND_BLACK        0x08
#define CONSOLE_FOREGROUND_BLUE         0x09
#define CONSOLE_FOREGROUND_GREEN        0x0A
#define CONSOLE_FOREGROUND_CYAN         0x0B
#define CONSOLE_FOREGROUND_RED          0x0C
#define CONSOLE_FOREGROUND_MAGENTA      0x0D
#define CONSOLE_FOREGROUND_BROWN        0x0E
#define CONSOLE_FOREGROUND_WHITE        0x0F
</span>

<span class="cp">#define COLOR_DEFAULT (CONSOLE_BACKGROUND_BLACK|CONSOLE_FOREGROUND_WHITE)
</span>
<span class="cp">#pragma pack(push, 1)
</span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_Struct_ConsoleCursor</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">cursor_offset</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">current_attribute</span><span class="p">;</span>
<span class="p">}</span> <span class="n">CONSOLESYSTEM</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_Charactor_Struct</span>
<span class="p">{</span>
	<span class="n">BYTE</span> <span class="n">bCharactor</span><span class="p">;</span>
	<span class="n">BYTE</span> <span class="n">bAttribute</span><span class="p">;</span>

<span class="p">}</span> <span class="n">CHARACTER_MEMORY</span><span class="p">;</span>

<span class="cp">#pragma pack(pop)
</span>
<span class="k">static</span> <span class="n">CONSOLESYSTEM</span> <span class="n">g_console_system</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="n">COLOR_DEFAULT</span><span class="p">};</span>


<span class="kt">void</span> <span class="nf">_PrintStringXY</span><span class="p">(</span><span class="kt">int</span> <span class="n">_x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">_y</span><span class="p">,</span> <span class="n">BYTE</span> <span class="n">_Attribute</span> <span class="p">,</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_str</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">_PrintChar_offset</span><span class="p">(</span><span class="kt">int</span> <span class="n">_offset</span><span class="p">,</span> <span class="n">BYTE</span> <span class="n">_attribute</span><span class="p">,</span> <span class="kt">char</span> <span class="n">_ch</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">_Printf</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">_str</span><span class="p">,</span> <span class="p">...);</span>
<span class="kt">void</span> <span class="nf">_SPrintf</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">_dst</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_str</span><span class="p">,</span> <span class="p">...);</span>
<span class="kt">char</span> <span class="nf">_GetCh</span><span class="p">();</span>

<span class="kt">void</span> <span class="nf">__VSPrintf</span><span class="p">(</span><span class="n">BYTE</span> <span class="n">_type</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">_dst</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">_arg</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">__NextLine</span><span class="p">();</span>
<span class="kt">void</span> <span class="nf">__NextScroll</span><span class="p">();</span>
<span class="kt">void</span> <span class="nf">__SetConsole_System</span><span class="p">(</span><span class="n">CONSOLESYSTEM</span> <span class="n">value</span><span class="p">);</span>
<span class="n">CONSOLESYSTEM</span> <span class="nf">__GetConsole_System</span><span class="p">();</span>


<span class="cp">#endif </span><span class="cm">/*__CONSOLE_H__*/</span><span class="cp">
</span>

</code></pre></div></div>

<p>define이 많다</p>

<p>하지만 자세히보면 그냥 Framebuffer를 구성할때 사용하는 attribute의 속성값이다.</p>

<p>CONSOLESYSTEM g_console_system 변수가 이제 커서의 위치, 출력 색상등을 담당한다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//Console.c</span>

<span class="kt">void</span> <span class="nf">__UpdateWithCheckConsoleCursor</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">g_console_system</span><span class="p">.</span><span class="n">cursor_offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;=</span>
		<span class="n">CONSOLE_HEIGHT</span> <span class="o">*</span> <span class="n">CONSOLE_WIDTH</span><span class="p">)</span>	
		<span class="p">{</span>
			<span class="n">__NextScroll</span><span class="p">();</span>	
			<span class="n">g_console_system</span><span class="p">.</span><span class="n">cursor_offset</span> <span class="o">=</span> <span class="n">CONSOLE_WIDTH</span><span class="o">*</span><span class="p">(</span><span class="n">CONSOLE_HEIGHT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>	
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">g_console_system</span><span class="p">.</span><span class="n">cursor_offset</span><span class="o">++</span><span class="p">;</span>	
		<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__putch</span><span class="p">(</span><span class="kt">char</span> <span class="n">_ch</span><span class="p">,</span> <span class="n">BYTE</span> <span class="n">_attribute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_PrintChar_offset</span><span class="p">(</span><span class="n">g_console_system</span><span class="p">.</span><span class="n">cursor_offset</span><span class="p">,</span> <span class="n">_attribute</span><span class="p">,</span> <span class="n">_ch</span><span class="p">);</span>
	<span class="n">__UpdateWithCheckConsoleCursor</span><span class="p">();</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">__PrintOutInteger</span><span class="p">(</span><span class="kt">long</span> <span class="n">_value</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_itoa</span><span class="p">(</span><span class="n">_value</span><span class="p">,</span> <span class="n">_buffer</span><span class="p">,</span> <span class="n">_base</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">__putch</span><span class="p">(</span><span class="n">_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">g_console_system</span><span class="p">.</span><span class="n">current_attribute</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">char</span><span class="o">*</span> <span class="nf">__PrintMemInteger</span><span class="p">(</span><span class="kt">long</span> <span class="n">_value</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">Buffer</span><span class="p">[</span><span class="n">FORMAT_BUFFER_SIZE</span><span class="p">];</span>
	<span class="n">_itoa</span><span class="p">(</span><span class="n">_value</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">,</span> <span class="n">_base</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">__StringLength</span><span class="p">(</span><span class="n">Buffer</span><span class="p">);</span>
	<span class="n">_MemCpy</span><span class="p">(</span><span class="n">_dst</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">_dst</span> <span class="o">+</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">__VSPrintf</span><span class="p">(</span><span class="n">BYTE</span> <span class="n">_type</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">_dst</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">Buffer</span><span class="p">[</span><span class="n">FORMAT_BUFFER_SIZE</span><span class="p">];</span>
	<span class="kt">char</span><span class="o">*</span> <span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_dst</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">char</span> <span class="n">output</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>	
		<span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">char</span><span class="o">*</span> <span class="n">str</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">QWORD</span> <span class="n">qvalue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">==</span> <span class="sc">'%'</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
			<span class="p">{</span>	
			<span class="k">case</span> <span class="sc">'d'</span><span class="p">:</span>
				<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">va_arg</span><span class="p">(</span><span class="n">_arg</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">_type</span> <span class="o">==</span> <span class="n">PRINT_OUTPUT</span><span class="p">)</span>
					<span class="n">__PrintOutInteger</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_type</span> <span class="o">==</span> <span class="n">PRINT_MEMORY</span><span class="p">)</span>
					<span class="n">dst</span> <span class="o">=</span> <span class="n">__PrintMemInteger</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">'o'</span><span class="p">:</span>
				<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">va_arg</span><span class="p">(</span><span class="n">_arg</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">_type</span> <span class="o">==</span> <span class="n">PRINT_OUTPUT</span><span class="p">)</span>
					<span class="n">__PrintOutInteger</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_type</span> <span class="o">==</span> <span class="n">PRINT_MEMORY</span><span class="p">)</span>
					<span class="n">dst</span> <span class="o">=</span> <span class="n">__PrintMemInteger</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">'x'</span><span class="p">:</span>
				<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">va_arg</span><span class="p">(</span><span class="n">_arg</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">_type</span> <span class="o">==</span> <span class="n">PRINT_OUTPUT</span><span class="p">)</span>
					<span class="n">__PrintOutInteger</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_type</span> <span class="o">==</span> <span class="n">PRINT_MEMORY</span><span class="p">)</span>
					<span class="n">dst</span> <span class="o">=</span> <span class="n">__PrintMemInteger</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
					
				<span class="k">break</span><span class="p">;</span>
				<span class="c1">//case 'f':</span>
				<span class="c1">//case 'g':</span>
				<span class="c1">//TODO: Floating Point</span>

			<span class="k">case</span> <span class="sc">'p'</span><span class="p">:</span>
				<span class="n">qvalue</span> <span class="o">=</span> <span class="p">(</span><span class="n">QWORD</span><span class="p">)(</span><span class="n">va_arg</span><span class="p">(</span><span class="n">_arg</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span><span class="p">));</span>
	
				<span class="k">if</span> <span class="p">(</span><span class="n">_type</span> <span class="o">==</span> <span class="n">PRINT_OUTPUT</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">__putch</span><span class="p">(</span><span class="sc">'0'</span><span class="p">,</span> <span class="n">g_console_system</span><span class="p">.</span><span class="n">current_attribute</span><span class="p">);</span>
					<span class="n">__putch</span><span class="p">(</span><span class="sc">'x'</span><span class="p">,</span> <span class="n">g_console_system</span><span class="p">.</span><span class="n">current_attribute</span><span class="p">);</span>
					<span class="n">__PrintOutInteger</span><span class="p">(</span><span class="n">qvalue</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_type</span> <span class="o">==</span> <span class="n">PRINT_MEMORY</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'0'</span><span class="p">;</span>
					<span class="n">dst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'x'</span><span class="p">;</span>
					<span class="n">dst</span> <span class="o">=</span> <span class="n">__PrintMemInteger</span><span class="p">(</span><span class="n">qvalue</span><span class="p">,</span> <span class="n">dst</span><span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
				<span class="p">}</span>
					
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">'c'</span><span class="p">:</span>
				<span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">va_arg</span><span class="p">(</span><span class="n">_arg</span><span class="p">,</span><span class="kt">int</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">_type</span> <span class="o">==</span> <span class="n">PRINT_OUTPUT</span><span class="p">)</span>
					<span class="n">__putch</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">g_console_system</span><span class="p">.</span><span class="n">current_attribute</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_type</span> <span class="o">==</span> <span class="n">PRINT_MEMORY</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
					<span class="n">dst</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">'s'</span><span class="p">:</span>
				<span class="n">str</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">va_arg</span><span class="p">(</span><span class="n">_arg</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">_type</span> <span class="o">==</span> <span class="n">PRINT_OUTPUT</span><span class="p">)</span>
					<span class="n">_Printf</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_type</span> <span class="o">==</span> <span class="n">PRINT_MEMORY</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">_SPrintf</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
					<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">__StringLength</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
					<span class="n">dst</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>

</code></pre></div></div>
<p>Printf 함수와 SPrintf 함수의 심장이 되는 VSPrintf 내부 모습이다.</p>

<p>위엔 VSPrintf 함수 구현을 돕기위해 정의한 함수들이다.</p>

<p>책과는 아마 많이 다르게 구현되있을탠데, 책에서는 Printf 에서 Buffer를 중간에 두고 있는점때문에 버퍼를 안두고 바로 쓰게끔 했다.</p>

<p>그중에 __putch도 있다.</p>

<p>아무튼 자세히 보면 %문자를 만나면 처리하는 형태로 출력문자를 처리하고,</p>

<p>Sprintf 냐 Printf냐에 따라 구현을 조금씩 다르게 했다.</p>

<p>잘 보면 %s 에 대해 다시 _Printf 를 하건 _SPrintf 를 하건 한다. 그 이유는 문자열안에 이스케이프 시퀀스가 등장하는것에 대한 처리때문이다.</p>

<p>이어서 Printf와 SPrintf함수의 구현을 보면 단순히 _VSPrintf를 타입에 맞추어 호출하고</p>

<p>커서위치를 조정해 주는 역할을 한다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//Console.c</span>

<span class="kt">void</span> <span class="nf">_Printf</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">_str</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">_arg</span><span class="p">;</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">_arg</span><span class="p">,</span> <span class="n">_str</span><span class="p">);</span>
	<span class="n">__VSPrintf</span><span class="p">(</span><span class="n">PRINT_OUTPUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_str</span><span class="p">,</span> <span class="n">_arg</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">_arg</span><span class="p">);</span>

	<span class="n">_SetCursor</span><span class="p">(</span><span class="n">g_console_system</span><span class="p">.</span><span class="n">cursor_offset</span> <span class="o">%</span> <span class="n">CONSOLE_WIDTH</span><span class="p">,</span> 
				<span class="n">g_console_system</span><span class="p">.</span><span class="n">cursor_offset</span> <span class="o">/</span> <span class="n">CONSOLE_WIDTH</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">_SPrintf</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">_dst</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_str</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">_arg</span><span class="p">;</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">_arg</span><span class="p">,</span> <span class="n">_str</span><span class="p">);</span>
	<span class="n">__VSPrintf</span><span class="p">(</span><span class="n">PRINT_MEMORY</span><span class="p">,</span> <span class="n">_dst</span><span class="p">,</span> <span class="n">_str</span><span class="p">,</span> <span class="n">_arg</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">_arg</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">_PrintStringXY</span><span class="p">(</span><span class="kt">int</span> <span class="n">_x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">_y</span><span class="p">,</span> <span class="n">BYTE</span> <span class="n">_Attribute</span> <span class="p">,</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CHARACTER_MEMORY</span><span class="o">*</span> <span class="n">Address</span> <span class="o">=</span> <span class="p">(</span> <span class="n">CHARACTER_MEMORY</span><span class="o">*</span> <span class="p">)</span> <span class="n">CONSOLE_VIDEO_MEMORY</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">Address</span><span class="o">+=</span> <span class="p">(</span> <span class="n">_y</span> <span class="o">*</span> <span class="mi">80</span> <span class="p">)</span> <span class="o">+</span> <span class="n">_x</span><span class="p">;</span>
	
	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">_str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">Address</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bCharactor</span> <span class="o">=</span> <span class="n">_str</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">Address</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bAttribute</span> <span class="o">=</span> <span class="n">_Attribute</span><span class="p">;</span>
		
	<span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">_PrintChar_offset</span><span class="p">(</span><span class="kt">int</span> <span class="n">_offset</span><span class="p">,</span> <span class="n">BYTE</span> <span class="n">_attribute</span><span class="p">,</span> <span class="kt">char</span> <span class="n">_ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CHARACTER_MEMORY</span><span class="o">*</span> <span class="n">Address</span> <span class="o">=</span> <span class="p">(</span> <span class="n">CHARACTER_MEMORY</span><span class="o">*</span> <span class="p">)</span> <span class="n">CONSOLE_VIDEO_MEMORY</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">Address</span><span class="o">+=</span> <span class="n">_offset</span><span class="p">;</span>
	<span class="n">Address</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bCharactor</span> <span class="o">=</span> <span class="n">_ch</span><span class="p">;</span>
	<span class="n">Address</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bAttribute</span> <span class="o">=</span> <span class="n">_attribute</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__NextLine</span><span class="p">()</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">addoffset</span> <span class="o">=</span><span class="n">CONSOLE_WIDTH</span> <span class="o">-</span> <span class="p">(</span><span class="n">g_console_system</span><span class="p">.</span><span class="n">cursor_offset</span><span class="o">%</span><span class="n">CONSOLE_WIDTH</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">g_console_system</span><span class="p">.</span><span class="n">cursor_offset</span> <span class="o">+</span> <span class="n">addoffset</span> <span class="o">&gt;=</span> <span class="n">CONSOLE_HEIGHT</span> <span class="o">*</span> <span class="n">CONSOLE_WIDTH</span><span class="p">)</span>	
		<span class="p">{</span>
			<span class="n">__NextScroll</span><span class="p">();</span>
			<span class="n">g_console_system</span><span class="p">.</span><span class="n">cursor_offset</span> <span class="o">=</span> <span class="n">CONSOLE_WIDTH</span><span class="o">*</span><span class="p">(</span><span class="n">CONSOLE_HEIGHT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">g_console_system</span><span class="p">.</span><span class="n">cursor_offset</span> <span class="o">+=</span> <span class="n">addoffset</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__NextScroll</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">_MemCpy</span><span class="p">(</span><span class="n">CONSOLE_VIDEO_MEMORY</span><span class="p">,</span> 
		<span class="n">CONSOLE_VIDEO_MEMORY</span> <span class="o">+</span> <span class="n">CONSOLE_WIDTH</span><span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CHARACTER_MEMORY</span><span class="p">),</span> 
			<span class="p">(</span><span class="n">CONSOLE_HEIGHT</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">CONSOLE_WIDTH</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CHARACTER_MEMORY</span><span class="p">)</span>  <span class="p">);</span>

	<span class="n">CHARACTER_MEMORY</span><span class="o">*</span> <span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">CHARACTER_MEMORY</span><span class="o">*</span><span class="p">)(</span><span class="n">CONSOLE_VIDEO_MEMORY</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">CONSOLE_HEIGHT</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">CONSOLE_WIDTH</span> <span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">CONSOLE_WIDTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bCharactor</span> <span class="o">=</span> <span class="sc">' '</span><span class="p">;</span>

<span class="p">}</span>

</code></pre></div></div>

<p>라인을 넘기는거라던가, 스클을 넘기는거라던가</p>

<p>좀 까다롭긴 해도 원리는 단순하다.</p>

<p>스크롤 내리는건, 비디오메모리에서, 한칸을 밀어버린다고 생각하면 된다(마지막줄은 초기화)</p>

<p>그러곤 커서위치를 정한다.</p>

<p>이렇게 까지 오고 마지막으론 _GetCh 함수를 구현했다.</p>

<p>잘 알듯이 단순히 문자 하나 받아오는 함수이다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//Console.c</span>
<span class="kt">char</span> <span class="nf">_GetCh</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">KEYDATA</span> <span class="n">keydata</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">GetKeyData</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keydata</span><span class="p">)</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">keydata</span><span class="p">.</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">KEY_DOWN</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">return</span> <span class="n">keydata</span><span class="p">.</span><span class="n">ASCIICode</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>이렇게 셸 만들 준비가 되었다.</p>

<p>일단, 좀 복잡할지도 모르지만 셸의 해더파일을 보면</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//Shell.c</span>
<span class="cp">#ifndef __SHELL_H__
#define __SHELL_H__
#include &lt;Types.h&gt;
#define SHELL_INPUT_BUFFER_SIZE 500
#define SHELL_PROMPT_MESSAGE    "0SOS&gt;"
</span>
<span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">CommandCallBack</span><span class="p">)</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">parameter</span><span class="p">);</span>

<span class="cp">#pragma pack(push, 1)
</span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">__Struct_ShellCommandEntry</span>
<span class="p">{</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">Command</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">Comment</span><span class="p">;</span>
    <span class="n">CommandCallBack</span> <span class="n">command_callback</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SHELLCOMMAND</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">__Struct_Shell_Parameters</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">Buffer</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">Length</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">CurrentPosition</span><span class="p">;</span>
<span class="p">}</span> <span class="n">PARAMETERLIST</span><span class="p">;</span>

<span class="cp">#pragma pack(pop)
</span>

<span class="c1">//--------------------------------------------------- *</span>
<span class="kt">void</span> <span class="nf">Command_Help</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_Parameter</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">Command_Clear</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_Parameter</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">Command_ShutDown</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_Parameter</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">Command_TotalRamSize</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_Parameter</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">Command_StringToNumber</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_Parameter</span><span class="p">);</span>
<span class="c1">//---------------------------------------------------*</span>
<span class="k">static</span> <span class="n">SHELLCOMMAND</span> <span class="n">g_ShellCommandTable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> 
    <span class="p">{</span><span class="s">"clear"</span><span class="p">,</span> <span class="s">"clear the consol</span><span class="se">\n</span><span class="s">-f {white, green, cyan,black} front color</span><span class="se">\n</span><span class="s">-b {black, white, blue} back ground</span><span class="se">\n</span><span class="s">"</span>
    <span class="p">,</span> <span class="n">Command_Clear</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"help"</span><span class="p">,</span> <span class="s">"help for 0SOS"</span><span class="p">,</span> <span class="n">Command_Help</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"shutdown"</span><span class="p">,</span> <span class="s">"Shutdown PC"</span><span class="p">,</span> <span class="n">Command_ShutDown</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"strtod"</span><span class="p">,</span> <span class="s">"String To Hex or Decimal"</span><span class="p">,</span> <span class="n">Command_StringToNumber</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"totalram"</span><span class="p">,</span> <span class="s">"Show Ram Size"</span><span class="p">,</span> <span class="n">Command_TotalRamSize</span><span class="p">}</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">Clear</span><span class="p">();</span>
<span class="kt">void</span> <span class="nf">SetAttribute</span><span class="p">(</span><span class="n">BYTE</span> <span class="n">_attribute</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">StartShell</span><span class="p">();</span>
<span class="kt">void</span> <span class="nf">ExecuteCommand</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">CommandBuffer</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">InitalizeParameter</span><span class="p">(</span><span class="n">PARAMETERLIST</span><span class="o">*</span> <span class="n">_List</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_Parameter</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">GetNextParameter</span><span class="p">(</span><span class="n">PARAMETERLIST</span><span class="o">*</span> <span class="n">_List</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_Parameter_Out</span><span class="p">);</span>



<span class="cp">#endif </span><span class="cm">/*__SHELL_H__*/</span><span class="cp">
</span>
</code></pre></div></div>

<p>셸 해더파일이다.</p>

<p>(…)</p>

<p>대충 구조는 커널 엔트리에서 StartShell 함수를 호출해서 무한 루프를 돌며 명령어를 받고 출력하고 해주는 역할을 한다.</p>

<p>여기서 눈에 띄는 친구가 있다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">CommandCallBack</span><span class="p">)</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">parameter</span><span class="p">);</span>
</code></pre></div></div>

<p>짜잔, 함수 포인터다.</p>

<p>이친구는 SHELLCOMMNAD 구조체 안에 들어가 있으면서</p>

<p>g_ShellCommandTable 을 통해 명령어와 함수를 이어줬다.</p>

<p>그리고 InitalzieParameter 과 
GetNextParameter 함수는 각각 파라미터 문자열을 등록하고, 그 문자열에서 파라미터 하나씩 때오는 함수다.</p>

<p>그 구조를 위해 PARAMETERLIST 구조체가 있다.</p>

<p>그리고 Command_로 시작하는 함수는 죄다 명령어 처리를 위한 콜백함수.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//Shell.c</span>

<span class="kt">void</span> <span class="nf">StartShell</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">__InitializeMemoryCheck</span><span class="p">();</span>
    <span class="kt">char</span> <span class="n">CommandBuffer</span><span class="p">[</span><span class="n">SHELL_INPUT_BUFFER_SIZE</span><span class="p">];</span>
    <span class="n">_SetCursor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">17</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">CommandBufferIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">_Printf</span><span class="p">(</span><span class="n">SHELL_PROMPT_MESSAGE</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">Prompt_length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SHELL_PROMPT_MESSAGE</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
       	<span class="n">BYTE</span> <span class="n">c</span> <span class="o">=</span> <span class="n">_GetCh</span><span class="p">();</span>

        <span class="k">if</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">KEY_BACKSPACE</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">CommandBufferIndex</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
                <span class="n">_GetCursor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">);</span>
                <span class="kt">int</span> <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">Prompt_length</span><span class="p">;</span>   
                <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">dx</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CommandBufferIndex</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">CommandBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">CommandBuffer</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
                <span class="p">}</span>
                
                <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">CONSOLE_WIDTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">_PrintStringXY</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">__GetConsole_System</span><span class="p">().</span><span class="n">current_attribute</span><span class="p">,</span> <span class="s">" "</span><span class="p">);</span>    
                <span class="p">}</span>
                

                <span class="n">_SetCursor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
                <span class="n">_Printf</span><span class="p">(</span><span class="n">SHELL_PROMPT_MESSAGE</span><span class="p">);</span>
                <span class="n">_Printf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">CommandBuffer</span><span class="p">);</span>
                <span class="k">if</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">Prompt_length</span><span class="p">)</span>
                    <span class="n">_SetCursor</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
                <span class="k">else</span>
                    <span class="n">_SetCursor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
               
                <span class="n">CommandBufferIndex</span> <span class="o">--</span><span class="p">;</span>
                <span class="k">if</span><span class="p">(</span><span class="n">CommandBufferIndex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">_SetCursor</span><span class="p">(</span><span class="n">Prompt_length</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>                    
                <span class="p">}</span>

            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">KEY_ENTER</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_Printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="n">CommandBufferIndex</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">CommandBuffer</span><span class="p">[</span><span class="n">CommandBufferIndex</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
                <span class="n">ExecuteCommand</span><span class="p">(</span><span class="n">CommandBuffer</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">_Printf</span><span class="p">(</span><span class="n">SHELL_PROMPT_MESSAGE</span><span class="p">);</span>
            <span class="n">CommandBufferIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">_MemSet</span><span class="p">(</span><span class="n">CommandBuffer</span><span class="p">,</span><span class="mi">0</span> <span class="p">,</span> <span class="n">SHELL_INPUT_BUFFER_SIZE</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">KEY_LSHIFT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">KEY_RSHIFT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">KEY_CAPSLOCK</span><span class="p">)</span>
                <span class="o">||</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">KEY_NUMLOCK</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">KEY_SCROLLLOCK</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">KEY_ARROW_LEFT</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">int</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">;</span>
            <span class="n">_GetCursor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">);</span>
            <span class="k">if</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">Prompt_length</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_SetCursor</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">KEY_ARROW_RIGHT</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">int</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">;</span>
            <span class="n">_GetCursor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">);</span>
            <span class="k">if</span><span class="p">((</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">CommandBufferIndex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_SetCursor</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">KEY_TAB</span><span class="p">)</span>
                <span class="n">c</span> <span class="o">=</span> <span class="sc">' '</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">CommandBufferIndex</span> <span class="o">&lt;</span> <span class="n">SHELL_INPUT_BUFFER_SIZE</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">CommandBuffer</span><span class="p">[</span><span class="n">CommandBufferIndex</span> <span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
                <span class="n">_Printf</span><span class="p">(</span><span class="s">"%c"</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
	<span class="p">}</span>    
<span class="p">}</span>
</code></pre></div></div>

<p>Start Shell 함수이다. 초반에 __InitalieMemoryCheck 함수는 Utility/Memory 에 구현되어있으며 메모리 사이즈를 체크해 글로벌 변수에 넣어두고</p>

<p>__GetTotalRamSize() 함수를 통해 가져온다.</p>

<p>뭐, 별거 없음.</p>

<p>밑에 코드를 보면, 대충 화살표나, 쉬프트, 캡스락 키에 대해 무시하게끔 만들었다.</p>

<p>지금까지는, 쉬프트나 그런 키를 입력할때 이상한 문자가 같이 딸려왔었다.</p>

<p>저 코드로 완전히 해결되었다. (다만 저기에 없는 ALT 키같은경우는 여전히 생긴다, 나중에 싹 추가해야지)</p>

<p>뭐, 백스페이스로 지우는거 처리를 하고 그런 역할을 한다.</p>

<p>그리고 가장 중요한 엔터를 누를때 명령어에 대한 처리는, ExecuteCommand함수를 통해 처리된다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kt">void</span> <span class="nf">ExecuteCommand</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">CommandBuffer</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">command_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">__StringLength</span><span class="p">(</span><span class="n">CommandBuffer</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="n">command_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">command_index</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">command_index</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">CommandBuffer</span><span class="p">[</span><span class="n">command_index</span><span class="p">]</span> <span class="o">==</span> <span class="sc">' '</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">const</span> <span class="kt">int</span> <span class="n">CommandTableSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">g_ShellCommandTable</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">SHELLCOMMAND</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">CommandTableSize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">command_length</span> <span class="o">=</span> <span class="n">__StringLength</span><span class="p">(</span><span class="n">g_ShellCommandTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Command</span><span class="p">);</span>
        <span class="k">if</span><span class="p">((</span><span class="n">command_length</span> <span class="o">==</span> <span class="n">command_index</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">_MemCmp</span><span class="p">(</span><span class="n">g_ShellCommandTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Command</span><span class="p">,</span> <span class="n">CommandBuffer</span><span class="p">,</span> <span class="n">command_index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">g_ShellCommandTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">command_callback</span><span class="p">(</span><span class="n">CommandBuffer</span> <span class="o">+</span> <span class="n">command_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span> 
    <span class="p">}</span>
      <span class="n">_Printf</span><span class="p">(</span><span class="s">"</span><span class="se">\'</span><span class="s">%s</span><span class="se">\'</span><span class="s"> command not found</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">CommandBuffer</span><span class="p">);</span>  

<span class="p">}</span>

</code></pre></div></div>
<p>이 함수는 간단하게, 명령어와 파라미터를 분리시키고, 명령어 테이블에서 명령어에 맞는 함수를 호출한다. 호출하면서 파라미터를 문자열로 넘겨주는 역할을 한다.</p>

<p>커멘드에 있는 모든 함수를 다 소개하기엔 너무 긴거같으니까</p>

<p>help 함수만 보고, 나머지는 <a href="https://github.com/DevSDK/0SOS/blob/master/02_Kernel64/Source/Console/Shell.c">깃헙에서 봐주면 좋겠다!</a></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//Shell.c</span>
<span class="kt">void</span> <span class="nf">Command_Help</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_Parameter</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">_Printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">_Printf</span><span class="p">(</span><span class="s">"============================= Help ===========================</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="k">const</span> <span class="kt">int</span> <span class="n">command_table_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">g_ShellCommandTable</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SHELLCOMMAND</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">max_command_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">command_table_size</span><span class="p">;</span> <span class="n">i</span> <span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">__StringLength</span><span class="p">(</span><span class="n">g_ShellCommandTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Command</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">max_command_length</span><span class="p">)</span>
            <span class="n">max_command_length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">command_table_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_Printf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">g_ShellCommandTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Command</span><span class="p">);</span>
        <span class="n">_GetCursor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">);</span>
        <span class="n">_SetCursor</span><span class="p">(</span><span class="n">max_command_length</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
        <span class="n">_Printf</span><span class="p">(</span><span class="s">" : %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">g_ShellCommandTable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Comment</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">_Printf</span><span class="p">(</span><span class="s">"============================= Help ===========================</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">_Printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    
<span class="p">}</span>
</code></pre></div></div>

<p>간단히 말하면 만들어둔 테이블 덕분에 help 땅 치면 위 함수가 호출이 된다.</p>

<p>셸까지 와보니까 슬슬 현대의 OS가 얼마나 대단한건지 보인다.</p>

<p>실제로 개발해보면 운영체제 개론에서 흔히 말하는 부팅과정과는 차원이 다르게 준비할 게 많다.</p>

<p>게다가 부트로더는 저장매체마다 다르게 동작해서 그것도 준비해야하고 ….</p>

<p>하지만 뭐랄까, 눈이 트인다고 해야하나? 로우레벨 프로그래밍에 대해서 눈이 확 트이기 시작하는 느낌이다.</p>

<p>다만, 시간이 많이 들어가긴 한다.</p>

<p>이제 다음은.. 타이머 디바이스 드라이버와,</p>

<p>다다음은 대망의… 테스크 기능으로 넘어가는…
쿨럭</p>

<p>아무튼.. 많이 오긴 왔지만, 갈길이 더 멀다! 힘내서 개발하자!</p>

        </div>

        

        
          
  <div class="page-comments">
    <div id="disqus_thread"></div>
    <script>
      var disqus_config = function () {
        this.page.url = 'https://devsdk.github.io/ko/development/2017/07/18/shell.html';
        this.page.identifier = 'https://devsdk.github.io/ko/development/2017/07/18/shell.html';
      };

      (function() {
        var d = document, s = d.createElement('script');
        s.src = 'https://devsdk.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>


        

        <nav class="page-pagination" role="navigation">
  
    <a class="page-previous" href="/ko/development/2017/07/13/InterruptKeyboard.html">
      <h4 class="page-pagination-label">Previous</h4>
      <span class="page-pagination-title">
        <i class="fas fa-arrow-left"></i> 키보드 드라이버의 업데이트-인터럽트 방식

      </span>
    </a>
  

  
    <a class="page-next" href="/ko/development/2017/08/03/timerdriver.html">
      <h4 class="page-pagination-label">Next</h4>
      <span class="page-pagination-title">
        시간과 관련된 드라이버 개발 완료.
 <i class="fas fa-arrow-right"></i>
      </span>
    </a>
  
</nav>

      </div>
    </div>
  </article>
</main>


    <footer id="footer" class="site-footer">
  <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
<div class="social-icons"><a class="social-icon" href="https://github.com/DevSDK"><i class="fab fa-github-square fa-2x" title="GitHub"></i></a><a class="social-icon" href="https://www.facebook.com/100006277740856"><i class="fab fa-facebook-square fa-2x" title="Facebook"></i></a><a class="social-icon" href="https://twitter.com/0xdevssh"><i class="fab fa-twitter-square fa-2x" title="Twitter"></i></a><a class="social-icon" href="https://www.linkedin.com/in/seokho-song/"><i class="fab fa-linkedin fa-2x" title="LinkedIn"></i></a><a class="social-icon" href="/ko/atom.xml"><i class="fas fa-rss-square fa-2x" title="Feed"></i></a></div><div class="copyright">
    
      <p>&copy; 2022 Seokho's blog. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://github.com/mmistakes/so-simple-theme" rel="nofollow">So Simple</a>.</p>
    
  </div>
</footer>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="/ko/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.12/js/all.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LCG7W119EZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LCG7W119EZ');
</script>


<!-- MathJax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  </body>

</html>
