<html lang="en" class="no-js">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  

  
    
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>How to collect coverage with Jest (V8) | Seokho’s blog</title>
<meta name="generator" content="Jekyll v3.9.4" />
<meta property="og:title" content="How to collect coverage with Jest (V8)" />
<meta name="author" content="Seokho Song" />
<meta property="og:locale" content="ko_KR" />
<meta name="description" content="Motivation I wanted to organize a workflow centered around coverage at my company and sought to understand precisely what coverage is." />
<meta property="og:description" content="Motivation I wanted to organize a workflow centered around coverage at my company and sought to understand precisely what coverage is." />
<link rel="canonical" href="https://blog.seokho.dev/development/2023/09/23/how-to-collect-coverage-jest-v8.html" />
<meta property="og:url" content="https://blog.seokho.dev/development/2023/09/23/how-to-collect-coverage-jest-v8.html" />
<meta property="og:site_name" content="Seokho’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-09-23T00:00:01+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="How to collect coverage with Jest (V8)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Seokho Song"},"dateModified":"2023-09-23T00:00:01+00:00","datePublished":"2023-09-23T00:00:01+00:00","description":"Motivation I wanted to organize a workflow centered around coverage at my company and sought to understand precisely what coverage is.","headline":"How to collect coverage with Jest (V8)","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.seokho.dev/development/2023/09/23/how-to-collect-coverage-jest-v8.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://blog.seokho.dev/images/avator.png"},"name":"Seokho Song"},"url":"https://blog.seokho.dev/development/2023/09/23/how-to-collect-coverage-jest-v8.html"}</script>
<!-- End Jekyll SEO tag -->


  

  <script>
    /* Cut the mustard */
    if ( 'querySelector' in document && 'addEventListener' in window ) {
      document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + 'js';
    }
  </script>

  <link rel="stylesheet" href="/assets/css/main.css">
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,400i,700,700i|Lora:400,400i,700,700i">
  <link rel="alternate" type="application/atom+xml" title="Seokho&#39;s blog" href="/atom.xml">
<!-- start custom head snippets -->
<link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
<link rel="manifest" href="/assets/site.webmanifest">
<link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<!-- Chrome, Firefox OS and Opera -->
<meta name="theme-color" content="#252a34" />
<!-- Windows Phone -->
<meta name="msapplication-navbutton-color" content="#252a34" />
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-status-bar-style" content="#252a34" />

<!-- end custom head snippets -->

</head>


  <body class="layout--post  how-to-collect-coverage-with-jest-v8">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#primary-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    
  <div class="navigation-wrapper">
    <a href="#menu-toggle" id="menu-toggle">Menu</a>
    <nav id="primary-nav" class="site-nav animated drop">
      <ul><li><a href="/about">About</a></li><li><a href="/">Home</a></li><li><a href="/posts/">Posts</a></li><li><a href="/categories/">Categories</a></li><li><a href="/tags/">Tags</a></li><li><a href="/search/">Search</a></li>
			<li><a href="/ko">한글</a></li>
		
	  </ul>
	</nav>
  </div><!-- /.navigation-wrapper -->


    <header class="masthead">
  <div class="wrap">
    
      <a href="/" class="site-logo" rel="home" title="Seokho's blog">
        <img src="/images/avator.png" class="site-logo-img animated fadeInDown" alt="Seokho's blog">
      </a>
    
    
      <h1 class="site-title animated fadeIn"><a href="/">Seokho's blog</a></h1>
      <p class="site-description animated fadeIn" itemprop="description">Development and Tech blog</p>
    
  </div>
</header><!-- /.masthead -->


    <main id="main" class="main-content" aria-label="Content">
  <article class="h-entry">
    

    <div class="page-wrapper">
      <header class="page-header">
        
        
          <h1 id="page-title" class="page-title p-name">How to collect coverage with Jest (V8)
</h1>
        
      </header>

      <div class="page-sidebar">
        <div class="page-author h-card p-author"><img src="/images/avator.png" class="author-avatar u-photo" alt="Seokho Song"><div class="author-info"><div class="author-name">
        <span class="p-name">Seokho Song</span>
      </div><ul class="author-links"><li class="author-link">
            <a class="u-url" rel="me" href="https://github.com/DevSDK"><i class="fab fa-github-square fa-lg" title="GitHub"></i></a>
          </li><li class="author-link">
            <a class="u-url" rel="me" href="https://www.facebook.com/100006277740856"><i class="fab fa-facebook-square fa-lg" title="Facebook"></i></a>
          </li><li class="author-link">
            <a class="u-url" rel="me" href="https://twitter.com/0xdevssh"><i class="fab fa-twitter-square fa-lg" title="Twitter"></i></a>
          </li><li class="author-link">
            <a class="u-url" rel="me" href="https://www.linkedin.com/in/seokho-song/"><i class="fab fa-linkedin fa-lg" title="LinkedIn"></i></a>
          </li></ul>

<span class="read-time">7 min read</span>

    <time class="page-date dt-published" datetime="2023-09-23T00:00:01+00:00"><a class="u-url" href="">September 23, 2023</a>
</time>

  </div>
</div>

        
  <h3 class="page-taxonomies-title" style="color:#494949">Categories</h3>
  <ul class="page-taxonomies" style="color:gray"><li class="page-taxonomy"><a class="p-category" href="/categories/#development" title="Pages filed under development">development</a></li>
  </ul>


        
  <h3 class="page-taxonomies-title" style="color:#484848">Tags</h3>
  <ul class="page-taxonomies" style="color:gray"><li class="page-taxonomy"><a href="/tags/#chromium" title="Pages tagged Chromium" rel="tag">Chromium</a></li><li class="page-taxonomy"><a href="/tags/#v8" title="Pages tagged V8" rel="tag">V8</a></li><li class="page-taxonomy"><a href="/tags/#javascript" title="Pages tagged Javascript" rel="tag">Javascript</a></li><li class="page-taxonomy"><a href="/tags/#jest" title="Pages tagged Jest" rel="tag">Jest</a></li>
  </ul>


		  <h3 class="page-taxonomies-title">LANGUAGES</h3>
  <ul class="page-taxonomies"> 
	  <li class="page-taxonomy">
	  
		
	  	<a href="/development/2023/09/23/how-to-collect-coverage-jest-v8.html" >English</a> </li>
		  	
	<li class="page-taxonomy">
	  

		
			 <a href="/ko/development/2023/09/23/how-to-collect-coverage-jest-v8.html" >한국어</a> </li>
	  
  </ul>

	  </div>

      <div class="page-content">
        <div class="e-content">
			<br/>
			<h2 id="motivation">Motivation</h2>
<p>I wanted to organize a workflow centered around coverage at my company and sought to understand precisely what coverage is.</p>

<h2 id="introduction">Introduction</h2>

<p>We will learn how <code class="language-plaintext highlighter-rouge">jest --CollectCoverage --coverageProvider=v8</code> measures coverage. Starting with jest, we will briefly examine v8 and understand how coverage is measured.</p>

<p>If you already know the theory of compilers (a bit), it will be easier to read.</p>

<h2 id="coverage">Coverage?</h2>

<blockquote>
  <p>In <a href="https://en.wikipedia.org/wiki/Software_engineering">software engineering</a>, <strong>code coverage</strong> is a percentage measure of the degree to which the <a href="https://en.wikipedia.org/wiki/Source_code">source code</a> of a <a href="https://en.wikipedia.org/wiki/Computer_program">program</a> is executed when a particular <a href="https://en.wikipedia.org/wiki/Test_suite">test suite</a> is run. - Wikipedia</p>

</blockquote>

<p>We are testing our code using jest and can measure test coverage through the <code class="language-plaintext highlighter-rouge">-CollectCoverage</code> option.</p>

<p>Target function:</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">function</span> <span class="nx">testFunc</span><span class="p">(</span><span class="nx">a</span><span class="p">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">b</span><span class="p">:</span> <span class="nx">number</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Test code:</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">testFunc</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">~/hooks/func</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">test</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span><span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">testFunc</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
<span class="p">})</span>
</code></pre></div></div>

<p>We can see the coverage information with uncovered lines.</p>

<h2><img src="/uploads/2023-09-23/coverage.png" alt="Untitled" /></h2>

<h2 id="coverage-in-jest">Coverage in jest</h2>

<p>How is this coverage measured? And what it is?</p>

<p>Let’s see with v8.</p>

<p>Jest internally uses <strong><a href="https://github.com/SimenB/collect-v8-coverage">collect-v8-coverage</a></strong> package. In the implementation:</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="nx">startInstrumenting</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>

    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">postSession</span><span class="p">(</span><span class="dl">'</span><span class="s1">Profiler.enable</span><span class="dl">'</span><span class="p">);</span>

    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">postSession</span><span class="p">(</span><span class="dl">'</span><span class="s1">Profiler.startPreciseCoverage</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="c1">// Start</span>
      <span class="na">callCount</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">detailed</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>As you can see, the <code class="language-plaintext highlighter-rouge">// Start</code> line performs the coverage measurement using <code class="language-plaintext highlighter-rouge">Profiler.startPreciseCoverage</code> Chrome Devtools Protocol.</p>

<p>This is a command that sends a request to V8 to utilize the coverage measurement feature in V8. You can find more details:</p>

<p>https://chromedevtools.github.io/devtools-protocol/tot/Profiler/</p>

<p>Now we know how to get coverage data with that protocol.</p>

<p>But how is the coverage collected specifically?</p>

<p>Below is an example of calculating the coverage of <code class="language-plaintext highlighter-rouge">test</code> function with that protocol.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">Session</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">inspector</span><span class="dl">"</span><span class="p">);</span>

<span class="kd">const</span> <span class="p">{</span> <span class="nx">promisify</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">util</span><span class="dl">"</span><span class="p">);</span>

<span class="nb">global</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Session</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">postP</span> <span class="o">=</span> <span class="nx">promisify</span><span class="p">(</span><span class="nb">global</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">post</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nb">global</span><span class="p">.</span><span class="nx">session</span><span class="p">));</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nb">global</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
  <span class="k">await</span> <span class="nx">postP</span><span class="p">(</span><span class="dl">"</span><span class="s2">Profiler.enable</span><span class="dl">"</span><span class="p">);</span>

  <span class="k">await</span> <span class="nx">postP</span><span class="p">(</span><span class="dl">"</span><span class="s2">Profiler.startPreciseCoverage</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">callCount</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">detailed</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="p">});</span>

  <span class="kd">function</span> <span class="nx">test</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">l</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">test</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="nx">v</span><span class="p">));</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">test</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="o">===</span> <span class="mi">30</span><span class="p">);</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">test</span><span class="p">(</span><span class="nx">l</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">20</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">r</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">postP</span><span class="p">(</span><span class="dl">"</span><span class="s2">Profiler.takePreciseCoverage</span><span class="dl">"</span><span class="p">);</span>

  <span class="k">await</span> <span class="nx">postP</span><span class="p">(</span><span class="dl">"</span><span class="s2">Profiler.stopPreciseCoverage</span><span class="dl">"</span><span class="p">);</span>
  <span class="k">await</span> <span class="nx">postP</span><span class="p">(</span><span class="dl">"</span><span class="s2">Profiler.disable</span><span class="dl">"</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">find</span><span class="p">((</span><span class="nx">f</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="dl">"</span><span class="s2">file://</span><span class="dl">"</span><span class="p">));</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
<span class="p">}</span>

<span class="nx">main</span><span class="p">();</span>
</code></pre></div></div>

<p>Executing result of above code on nodejs environment:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "scriptId": "481",
    "url": "file:///Users/seokho/workspace/chromium/playground/v8_test.js",
    "functions": [
        {
            "functionName": "main",
            "ranges": [
                {
                    "startOffset": 182,
                    "endOffset": 777,
                    "count": 1
                }
            ],
            "isBlockCoverage": false
        },
        {
            "functionName": "test",
            "ranges": [
                {
                    "startOffset": 372, // byte offset
                    "endOffset": 454,
                    "count": 1
                },
                {
                    "startOffset": 409,
                    "endOffset": 431,
                    "count": 0
                }
            ],
            "isBlockCoverage": true
        },
        {
            "functionName": "",
            "ranges": [
                {
                    "startOffset": 699,
                    "endOffset": 729,
                    "count": 0
                }
            ],
            "isBlockCoverage": false
        }
    ]
}
</code></pre></div></div>

<p>We can know the information of coverage including how many time to execute, does it block coverage or not, and the byte offset. We can calculate the point of coverage information in the source code.</p>

<hr />

<h2 id="compiler-overview">Compiler overview</h2>

<p>The below sections may require knowledge of the theory of compiler overview.
I’ll describe it briefly.</p>

<p><img src="/uploads/2023-09-23/v8.png" alt="Untitled" /></p>

<p>The compiler has multiple pipelines that process the source code to AST and finally target code like x86 Assembly, bytecode, and so on.</p>

<p><img src="/uploads/2023-09-23/ast.png" alt="Untitled" /></p>

<p>Visualized AST</p>

<p>The pipeline that processes the source code to AST and finally results in IR(Intermediate Representation; v8 turboshaft) is called “compiler frontend”
The target codes generator for a given IR is called ‘compiler backend’. The object code is executed on the machine with x86 asm or VM with bytecode.</p>

<p>Compilers make the source code to Tree and then generate IR after that make Object code with that IR.</p>

<p>To summarize, the compiler compiles the code by first creating AST, then converting the tree into an IR, and finally generating target code through the intermediate representation.</p>

<hr />

<h2 id="how-to-check-coverage-in-v8">How to check coverage in V8</h2>

<p>How the coverage is calculated on V8?</p>

<p>V8 supports two ways to collect coverages:</p>

<ol>
  <li>Best effort
    <ol>
      <li>Not significantly impact execution performance but may lose data due to GC and other things.
        <ol>
          <li><a href="https://chromedevtools.github.io/devtools-protocol/tot/Profiler/#method-getBestEffortCoverage">Profiler.getBestEffortCoverage()</a></li>
        </ol>
      </li>
    </ol>
  </li>
  <li>Precise
    <ol>
      <li>Accurate execution counts with detail position and without losing data due to GC, but this may impact execution performance.
        <ol>
          <li><a href="https://chromedevtools.github.io/devtools-protocol/tot/Profiler/#method-startPreciseCoverage">Profiler.startPreciseCoverage(callCount, detailed)</a></li>
        </ol>
      </li>
    </ol>
  </li>
</ol>

<p>Best-effort coverage is a method that utilizes the mechanisms of V8.</p>

<p>Firstly, relies on an element called ‘invoke-counter’. When a function is called through V8’s ignition interpreter, the invoke counter in the feedback vector is incremented each time the function is called.</p>

<p>Secondly, the reuse mechanism involves determining the source range of a function. When collecting coverage, the information of source range associated with invoke-counter is required.</p>

<p>To achieve this, <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/toString">Function.prototype.toString</a> function is used to identify the location of the function. Subsequently, a substring is extracted to internally determine the starting and ending points of the function.</p>

<p>Therefore, the Best Effort coverage measurement is performance-friendly because this relies on reusing byproduct(?) from the code execution.</p>

<p>However, this has limitations because the result is approximate coverage information and can be collected from the GC or other things.</p>

<p>Precise coverage is also called ‘block-level’ coverage, meaning it measures coverage for each individual expression block. For example, this measures coverage for both the “then” block and the “else” block within an “if” statement.</p>

<p>Please note that Best Effort coverage, also use invoke-counter, can be misleading in this context. The invoke-counter in Best effort coverage can only determine source ranges not a block level.</p>

<p>In contrast, Precise coverage measurement in V8 traverses AST and inserts the <code class="language-plaintext highlighter-rouge">IncBlockCounter</code> command during bytecode generation for Conditional blocks. Depending on whether this command is executed, we can get detailed coverage data at the block-level.</p>

<hr />

<h2 id="see-with-example">See with example</h2>

<p>In this section, we will see how the concepts described earlier actually work in practice.</p>

<p>Let’s assume we want to measure coverage for the following function:</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">test</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">a</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">0</span>
    <span class="p">}</span> 
    <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="kd">let</span> <span class="nx">l</span> <span class="o">=</span> <span class="mi">10</span>
  <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="mi">20</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">test</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span><span class="nx">v</span><span class="p">))</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">test</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="o">===</span> <span class="mi">30</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">test</span><span class="p">(</span><span class="nx">l</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">20</span><span class="p">)</span>
</code></pre></div></div>

<p>V8 compiler frontend generates AST from parsing the above code.</p>

<p>Let’s see AST with the following command:</p>

<p><code class="language-plaintext highlighter-rouge">./d8 --print-ast ~/workspace/chromium/playground/test.js</code></p>

<pre><code class="language-ABAP">[generating bytecode for function: test]
--- AST ---
FUNC at 13
. KIND 0
. LITERAL ID 1
. SUSPEND COUNT 0
. NAME "test"
. PARAMS
. . VAR (0x158832470) (mode = VAR, assigned = false) "a"
. . VAR (0x1588324f0) (mode = VAR, assigned = false) "b"
. DECLS
. . VARIABLE (0x158832470) (mode = VAR, assigned = false) "a"
. . VARIABLE (0x1588324f0) (mode = VAR, assigned = false) "b"
. IF at 24 // BLOCK
. . CONDITION at 29 // BLOCK
. . . GT at 29 // BLOCK
. . . . VAR PROXY parameter[0] (0x158832470) (mode = VAR, assigned = false) "a"
. . . . LITERAL 20 // BLOCK
. . THEN at -1 // BLOCK
. . . BLOCK at -1 // BLOCK
. . . . RETURN at 41 // BLOCK
. . . . . LITERAL 0 // BLOCK
. RETURN at 57// BLOCK 
. . ADD at 66
. . . VAR PROXY parameter[0] (0x158832470) (mode = VAR, assigned = false) "a"
. . . VAR PROXY parameter[1] (0x1588324f0) (mode = VAR, assigned = false) "b"
</code></pre>

<p>The noted ‘block’ in the AST will represent the block of the function structure and conditions.</p>

<p>Then, the resulting IR(Intermediate Representation), created through the AST will be passed to the compiler’s backend.</p>

<p>Below is the actual bytecode to run on the VM that the compiler generates by providing the IR from AST:</p>

<p><code class="language-plaintext highlighter-rouge">node --print-bytecode --print-bytecode-filter="test" ~/workspace/chromium/playground/v8_test.js</code></p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">seokho</span><span class="p">@</span><span class="nd">Dave</span> <span class="o">~</span><span class="sr">/workspace/</span><span class="nx">chromium</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">out</span><span class="o">/</span><span class="nx">Default</span> <span class="o">%</span> <span class="nx">node</span> <span class="o">--</span><span class="nx">print</span><span class="o">-</span><span class="nx">bytecode</span> <span class="o">--</span><span class="nx">print</span><span class="o">-</span><span class="nx">bytecode</span><span class="o">-</span><span class="nx">filter</span><span class="o">=</span><span class="dl">"</span><span class="s2">test</span><span class="dl">"</span> <span class="o">~</span><span class="sr">/workspace/</span><span class="nx">chromium</span><span class="o">/</span><span class="nx">playground</span><span class="o">/</span><span class="nx">v8_test</span><span class="p">.</span><span class="nx">js</span>
<span class="p">[</span><span class="nx">generated</span> <span class="nx">bytecode</span> <span class="k">for</span> <span class="kd">function</span><span class="p">:</span> <span class="nx">test</span> <span class="p">(</span><span class="mh">0x00a7d39a6811</span> <span class="o">&lt;</span><span class="nx">SharedFunctionInfo</span> <span class="nx">test</span><span class="o">&gt;</span><span class="p">)]</span>
<span class="nx">Bytecode</span> <span class="nx">length</span><span class="p">:</span> <span class="mi">21</span>
<span class="nx">Parameter</span> <span class="nx">count</span> <span class="mi">3</span>
<span class="nx">Register</span> <span class="nx">count</span> <span class="mi">0</span>
<span class="nx">Frame</span> <span class="nx">size</span> <span class="mi">0</span>
<span class="nx">OSR</span> <span class="nx">urgency</span><span class="p">:</span> <span class="mi">0</span>
<span class="nx">Bytecode</span> <span class="nx">age</span><span class="p">:</span> <span class="mi">0</span>
  <span class="mi">385</span> <span class="nx">E</span><span class="o">&gt;</span> <span class="mh">0xa7d39b8b88</span> <span class="p">@</span>    <span class="mi">0</span> <span class="p">:</span> <span class="nx">b3</span> <span class="mi">00</span>             <span class="nx">IncBlockCounter</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="mi">398</span> <span class="nx">S</span><span class="o">&gt;</span> <span class="mh">0xa7d39b8b8a</span> <span class="p">@</span>    <span class="mi">2</span> <span class="p">:</span> <span class="mi">0</span><span class="nx">d</span> <span class="mi">14</span>             <span class="nx">LdaSmi</span> <span class="p">[</span><span class="mi">20</span><span class="p">]</span>
  <span class="mi">403</span> <span class="nx">E</span><span class="o">&gt;</span> <span class="mh">0xa7d39b8b8c</span> <span class="p">@</span>    <span class="mi">4</span> <span class="p">:</span> <span class="mi">6</span><span class="nx">e</span> <span class="mi">03</span> <span class="mi">00</span>          <span class="nx">TestGreaterThan</span> <span class="nx">a0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
         <span class="mh">0xa7d39b8b8f</span> <span class="p">@</span>    <span class="mi">7</span> <span class="p">:</span> <span class="mi">99</span> <span class="mi">06</span>             <span class="nx">JumpIfFalse</span> <span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="p">(</span><span class="mh">0xa7d39b8b95</span> <span class="p">@</span> <span class="mi">13</span><span class="p">)</span>
         <span class="mh">0xa7d39b8b91</span> <span class="p">@</span>    <span class="mi">9</span> <span class="p">:</span> <span class="nx">b3</span> <span class="mi">01</span>             <span class="nx">IncBlockCounter</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="mi">417</span> <span class="nx">S</span><span class="o">&gt;</span> <span class="mh">0xa7d39b8b93</span> <span class="p">@</span>   <span class="mi">11</span> <span class="p">:</span> <span class="mi">0</span><span class="nx">c</span>                <span class="nx">LdaZero</span>
  <span class="mi">425</span> <span class="nx">S</span><span class="o">&gt;</span> <span class="mh">0xa7d39b8b94</span> <span class="p">@</span>   <span class="mi">12</span> <span class="p">:</span> <span class="nx">a9</span>                <span class="nx">Return</span>
         <span class="mh">0xa7d39b8b95</span> <span class="p">@</span>   <span class="mi">13</span> <span class="p">:</span> <span class="nx">b3</span> <span class="mi">02</span>             <span class="nx">IncBlockCounter</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span>
  <span class="mi">437</span> <span class="nx">S</span><span class="o">&gt;</span> <span class="mh">0xa7d39b8b97</span> <span class="p">@</span>   <span class="mi">15</span> <span class="p">:</span> <span class="mi">0</span><span class="nx">b</span> <span class="mi">04</span>             <span class="nx">Ldar</span> <span class="nx">a1</span>
  <span class="mi">446</span> <span class="nx">E</span><span class="o">&gt;</span> <span class="mh">0xa7d39b8b99</span> <span class="p">@</span>   <span class="mi">17</span> <span class="p">:</span> <span class="mi">39</span> <span class="mi">03</span> <span class="mi">01</span>          <span class="nx">Add</span> <span class="nx">a0</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="mi">450</span> <span class="nx">S</span><span class="o">&gt;</span> <span class="mh">0xa7d39b8b9c</span> <span class="p">@</span>   <span class="mi">20</span> <span class="p">:</span> <span class="nx">a9</span>                <span class="nx">Return</span>
<span class="nx">Constant</span> <span class="nx">pool</span> <span class="p">(</span><span class="nx">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="nx">Handler</span> <span class="nx">Table</span> <span class="p">(</span><span class="nx">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="nx">Source</span> <span class="nx">Position</span> <span class="nx">Table</span> <span class="p">(</span><span class="nx">size</span> <span class="o">=</span> <span class="mi">19</span><span class="p">)</span>
<span class="mh">0x00a7d39b8ba1</span> <span class="o">&lt;</span><span class="nx">ByteArray</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span>
</code></pre></div></div>

<p>We can finally see <code class="language-plaintext highlighter-rouge">IncBlockCounter</code> command has been added to the blocks.</p>

<p><code class="language-plaintext highlighter-rouge">IncBlockCounter(slot)</code> command increments the invoke-counter for the corresponding block slot.</p>

<p>This information, accessed as a result through the devtools protocol, is what constitutes the coverage data mentioned in the first section.</p>

<hr />

<h3 id="references">References</h3>

<p>https://v8.dev/blog/javascript-code-coverage</p>

<p>https://chromedevtools.github.io/devtools-protocol/tot/Profiler/#method-startPreciseCoverage</p>

<p>https://docs.google.com/document/d/1wCydi2HEZRF0skDeLb6CH0abZnTyVo5Vz5u-jhwi7es/mobilebasic</p>

        </div>

        

        
          
  <div class="page-comments">
    <div id="disqus_thread"></div>
    <script>
      var disqus_config = function () {
        this.page.url = 'https://blog.seokho.dev/development/2023/09/23/how-to-collect-coverage-jest-v8.html';
        this.page.identifier = 'https://blog.seokho.dev/development/2023/09/23/how-to-collect-coverage-jest-v8.html';
      };

      (function() {
        var d = document, s = d.createElement('script');
        s.src = 'https://devsdk.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>


        

        <nav class="page-pagination" role="navigation">
  
    <a class="page-previous" href="/development/2022/12/20/css-trigonometric-functions.html">
      <h4 class="page-pagination-label">Previous</h4>
      <span class="page-pagination-title">
        <i class="fas fa-arrow-left"></i> I released CSS Trigonometric Functions

      </span>
    </a>
  

  
    <a class="page-next" href="/development/2024/03/03/V8-Float16Array.html">
      <h4 class="page-pagination-label">Next</h4>
      <span class="page-pagination-title">
        The first journey of implementing Float16Array into V8
 <i class="fas fa-arrow-right"></i>
      </span>
    </a>
  
</nav>

      </div>
    </div>
  </article>
</main>


    <footer id="footer" class="site-footer">
  <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
<div class="social-icons"><a class="social-icon" href="https://github.com/DevSDK"><i class="fab fa-github-square fa-2x" title="GitHub"></i></a><a class="social-icon" href="https://www.facebook.com/100006277740856"><i class="fab fa-facebook-square fa-2x" title="Facebook"></i></a><a class="social-icon" href="https://twitter.com/0xdevssh"><i class="fab fa-twitter-square fa-2x" title="Twitter"></i></a><a class="social-icon" href="https://www.linkedin.com/in/seokho-song/"><i class="fab fa-linkedin fa-2x" title="LinkedIn"></i></a><a class="social-icon" href="/atom.xml"><i class="fas fa-rss-square fa-2x" title="Feed"></i></a></div><div class="copyright">
    
      <p>&copy; 2024 Seokho's blog. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://github.com/mmistakes/so-simple-theme" rel="nofollow">So Simple</a>.</p>
    
  </div>
</footer>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.12/js/all.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LCG7W119EZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LCG7W119EZ');
</script>


<!-- MathJax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  </body>

</html>
